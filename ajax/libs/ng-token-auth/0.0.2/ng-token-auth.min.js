angular.module("ng-token-auth",["ngCookies"]).provider("$auth",function(){var t;return t={apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",confirmationSuccessUrl:window.location.href,tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}},{configure:function(e){return angular.extend(t,e)},$get:["$http","$q","$location","$cookies","$cookieStore","$window","$timeout","$rootScope",function(){return function(e,n,i,r,u,o,s,a){return{token:null,uid:null,dfd:null,config:t,user:{},submitRegistration:function(n){return console.log("submitting registration",n),angular.extend(n,{confirm_success_url:t.confirmationSuccessUrl}),e.post(t.apiUrl+t.emailRegistrationPath,n)},submitLogin:function(i){return console.log("params",i),this.dfd=n.defer(),e.post(t.apiUrl+t.emailSignInPath,i).success(function(t){return function(e){return console.log("this",t),console.log("resp",e.data),t.handleValidAuth(e.data)}}(this)).error(function(t){return function(){return t.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]})}}(this)),this.dfd.promise},authenticate:function(t){var e;return null==this.dfd&&(this.dfd=n.defer(),e=this.openAuthWindow(t),this.requestCredentials(e)),this.dfd},openAuthWindow:function(e){return o.open(t.apiUrl+t.authProviderPaths[e])},requestCredentials:function(t){return t.closed?this.rejectDfd({reason:"unauthorized",errors:["User canceled login"]}):(t.postMessage("requestCredentials","*"),this.t=s(function(e){return function(){return e.requestCredentials(t)}}(this),500))},rejectDfd:function(t){return this.invalidateTokens(),null!=this.dfd?(this.dfd.reject(t),s(function(t){return function(){return t.dfd=null}}(this))):void 0},resolveDfd:function(){return this.dfd.resolve({id:this.user.id}),s(function(t){return function(){return t.dfd=null,a.$digest(),console.log("user",t.user)}}(this),0)},validateUser:function(){return null==this.dfd&&(this.dfd=n.defer(),this.token&&this.uid&&this.user.id?this.resolveDfd():(void 0!==i.search().token?(this.token=i.search().token,this.uid=i.search().uid):u.get("auth_token")&&(this.token=u.get("auth_token"),this.uid=u.get("auth_uid")),this.token&&this.uid?this.validateToken():this.rejectDfd({reason:"unauthorized",errors:["No credentials"]}))),this.dfd.promise},validateToken:function(){return e.post(t.apiUrl+t.tokenValidationPath,{auth_token:this.token,uid:this.uid}).success(function(t){return function(e){return console.log("validate token resp",e),t.handleValidAuth(e.data)}}(this)).error(function(t){return function(){return t.dfd.reject({reason:"unauthorized",errors:["Invalid/expired credentials"]}),s(function(){return t.dfd=null},0)}}(this))},invalidateTokens:function(){var t,n,i;i=this.user;for(t in i)n=i[t],delete this.user[t];return this.token=null,this.uid=null,delete r.auth_token,delete r.auth_uid,e.defaults.headers.common.Authorization=""},persistTokens:function(t){return this.token=t.auth_token,this.uid=t.uid,u.put("auth_token",this.token),u.put("auth_uid",this.uid),e.defaults.headers.common.Authorization=this.buildAuthHeader()},buildAuthHeader:function(){return"token="+this.token+" uid="+this.uid},signOut:function(){return e["delete"](t.apiUrl+t.signOutUrl).success(function(t){return function(){return t.invalidateTokens()}}(this)).error(function(t){return function(){return t.invalidateTokens()}}(this))},handleValidAuth:function(t){return null!=this.t&&s.cancel(this.t),angular.extend(this.user,t),this.token=this.user.auth_token,this.uid=this.user.uid,this.persistTokens(this.user),this.resolveDfd()},cancelAuth:function(){return s.cancel(this.t),this.rejectDfd()},apiUrl:function(){return null==this._apiUrl&&(this._apiUrl=t.proxyIf()?"/proxy":t.apiUrl),this._apiUrl}}}}(this)]}}).run(function(t,e,n){return e.addEventListener("message",function(){return function(e){return"deliverCredentials"===e.data.message&&(e.source.close(),delete e.data.message,t.handleValidAuth(e.data)),"authFailure"===e.data.message?(e.source.close(),t.cancelAuth()):void 0}}(this)),n.user=t.user,n.githubLogin=function(){return t.authenticate("github")},n.facebookLogin=function(){return t.authenticate("facebook")},n.googleLogin=function(){return t.authenticate("google")},n.signOut=function(){return t.signOut()},n.submitRegistration=function(e){return t.submitRegistration(e)},n.submitLogin=function(e){return t.submitLogin(e)},t.validateUser()});