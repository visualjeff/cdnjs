angular.module("ng-token-auth",["ngCookies"]).provider("$auth",function(){var t;return t={apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",confirmationSuccessUrl:window.location.href,tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}},{configure:function(e){return angular.extend(t,e)},$get:["$http","$q","$location","$cookies","$cookieStore","$window","$timeout","$rootScope",function(){return function(e,r,n,i,u,a,o,s){return{header:null,dfd:null,config:t,user:{},submitRegistration:function(r){return angular.extend(r,{confirm_success_url:t.confirmationSuccessUrl}),e.post(this.apiUrl()+t.emailRegistrationPath,r).success(function(){return s.$broadcast("auth:registration-email-sent",r)}).error(function(t){return s.$broadcast("auth:registration-email-failed",t)})},submitLogin:function(n){return this.dfd=r.defer(),e.post(this.apiUrl()+t.emailSignInPath,n).success(function(t){return function(e){return t.handleValidAuth(e.data),s.$broadcast("auth:login",t.user)}}(this)).error(function(t){return function(e){return t.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]}),s.$broadcast("auth:failure",e)}}(this)),this.dfd.promise},authenticate:function(t){var e;return null==this.dfd&&(this.dfd=r.defer(),e=this.openAuthWindow(t),this.requestCredentials(e)),this.dfd},openAuthWindow:function(e){return a.open(this.apiUrl()+t.authProviderPaths[e])},requestCredentials:function(t){return t.closed?(this.rejectDfd({reason:"unauthorized",errors:["User canceled login"]}),s.$broadcast("auth:window-closed")):(t.postMessage("requestCredentials","*"),this.t=o(function(e){return function(){return e.requestCredentials(t)}}(this),500))},rejectDfd:function(t){return this.invalidateTokens(),null!=this.dfd?(this.dfd.reject(t),o(function(t){return function(){return t.dfd=null}}(this),0)):void 0},resolveDfd:function(){return this.dfd.resolve({id:this.user.id}),o(function(t){return function(){return t.dfd=null,s.$digest()}}(this),0)},validateUser:function(){var t,i,a;return null==this.dfd&&(this.dfd=r.defer(),this.header&&this.user.id?this.resolveDfd():(void 0!==n.search().token?(i=n.search().token,t=n.search().client_id,a=n.search().uid,n.url(n.path()),this.setAuthHeader(this.buildAuthToken(i,t,a))):u.get("auth_header")&&(this.header=u.get("auth_header"),e.defaults.headers.common.Authorization=this.header),this.header?this.validateToken():(this.rejectDfd({reason:"unauthorized",errors:["No credentials"]}),s.$broadcast("auth:invalid")))),this.dfd.promise},validateToken:function(){return e.get(this.apiUrl()+t.tokenValidationPath).success(function(t){return function(e){return t.handleValidAuth(e.data),s.$broadcast("auth:validated",t.user)}}(this)).error(function(t){return function(){return t.dfd.reject({reason:"unauthorized",errors:["Invalid/expired credentials"]}),o(function(){return t.dfd=null},0)}}(this))},invalidateTokens:function(){var t,r,n;n=this.user;for(t in n)r=n[t],delete this.user[t];return this.header=null,delete i.auth_header,e.defaults.headers.common.Authorization=""},signOut:function(){return e["delete"](this.apiUrl()+t.signOutUrl).success(function(t){return function(){return t.invalidateTokens(),s.$broadcast("auth:logout-success")}}(this)).error(function(){return function(t){return s.$broadcast("auth:logout-failure",t)}}(this))},handleValidAuth:function(t,e){return null==e&&(e=!1),null!=this.t&&o.cancel(this.t),angular.extend(this.user,t),e&&this.setAuthHeader(this.buildAuthToken(this.user.auth_token,this.user.client_id,this.user.uid)),this.resolveDfd()},cancelAuth:function(t){return o.cancel(this.t),this.rejectDfd(t),s.$broadcast("auth:failure",t)},buildAuthToken:function(t,e,r){return"token="+t+" client="+e+" uid="+r},setAuthHeader:function(t){return this.header=e.defaults.headers.common.Authorization=t,u.put("auth_header",t)},apiUrl:function(){return null==this._apiUrl&&(this._apiUrl=t.proxyIf()?"/proxy":t.apiUrl),this._apiUrl}}}}(this)]}}).config(function(t){return t.interceptors.push(function(t){return{response:function(e){return t.invoke(function(t,r){return e.headers("Authorization")?r.setAuthHeader(e.headers("Authorization")):void 0}),e}}})}).run(function(t,e,r){return e.addEventListener("message",function(){return function(e){return"deliverCredentials"===e.data.message&&(e.source.close(),delete e.data.message,t.handleValidAuth(e.data,!0),r.$broadcast("auth:login",e.data)),"authFailure"===e.data.message?(e.source.close(),t.cancelAuth({reason:"unauthorized",errors:[e.data.error]})):void 0}}(this)),r.user=t.user,r.authenticate=function(e){return t.authenticate(e)},r.signOut=function(){return t.signOut()},r.submitRegistration=function(e){return t.submitRegistration(e)},r.submitLogin=function(e){return t.submitLogin(e)},t.validateUser()});