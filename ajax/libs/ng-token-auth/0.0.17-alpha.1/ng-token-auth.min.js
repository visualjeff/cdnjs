angular.module("ng-token-auth",["ngCookies"]).provider("$auth",function(){var t;return t={apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",confirmationSuccessUrl:window.location.href,passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",passwordResetSuccessUrl:window.location.href,tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}},{configure:function(e){return angular.extend(t,e)},$get:["$http","$q","$location","$cookies","$cookieStore","$window","$timeout","$rootScope",function(){return function(e,r,n,s,i,u,a,o){return{header:null,dfd:null,config:t,user:{},mustResetPassword:!1,submitRegistration:function(r){return angular.extend(r,{confirm_success_url:t.confirmationSuccessUrl}),e.post(this.apiUrl()+t.emailRegistrationPath,r).success(function(){return o.$broadcast("auth:registration-email-success",r)}).error(function(t){return o.$broadcast("auth:registration-email-error",t)})},submitLogin:function(n){return this.dfd=r.defer(),e.post(this.apiUrl()+t.emailSignInPath,n).success(function(t){return function(e){return t.handleValidAuth(e.data),o.$broadcast("auth:login-success",t.user)}}(this)).error(function(t){return function(e){return t.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]}),o.$broadcast("auth:login-error",e)}}(this)),this.dfd.promise},requestPasswordReset:function(r){return r.redirect_url=t.passwordResetSuccessUrl,e.post(this.apiUrl()+t.passwordResetPath,r).success(function(){return o.$broadcast("auth:password-reset-success",r)}).error(function(t){return o.$broadcast("auth:password-reset-error",t)})},updatePassword:function(r){return e.put(this.apiUrl()+t.passwordUpdatePath,r).success(function(t){return function(e){return o.$broadcast("auth:password-change-success",e),t.mustResetPassword=!1}}(this)).error(function(t){return o.$broadcast("auth:password-change-error",t)})},authenticate:function(t){var e;return null==this.dfd&&(this.dfd=r.defer(),e=this.openAuthWindow(t),this.requestCredentials(e)),this.dfd},openAuthWindow:function(e){var r;return r=t.apiUrl+t.authProviderPaths[e]+"?auth_origin_url="+window.location.href,this.useExternalWindow()?u.open(r):u.location.href=u.location.protocol+r},requestCredentials:function(t){return t.closed?(this.rejectDfd({reason:"unauthorized",errors:["User canceled login"]}),o.$broadcast("auth:window-closed")):(t.postMessage("requestCredentials","*"),this.t=a(function(e){return function(){return e.requestCredentials(t)}}(this),500))},rejectDfd:function(t){return this.invalidateTokens(),null!=this.dfd?(this.dfd.reject(t),a(function(t){return function(){return t.dfd=null}}(this),0)):void 0},resolveDfd:function(){return this.dfd.resolve({id:this.user.id}),a(function(t){return function(){return t.dfd=null,o.$digest()}}(this),0)},validateUser:function(){var t,s,u;return null==this.dfd&&(this.dfd=r.defer(),this.header&&this.user.id?this.resolveDfd():(void 0!==n.search().token?(s=n.search().token,t=n.search().client_id,u=n.search().uid,this.mustResetPassword=n.search().reset_password,this.firstTimeLogin=n.search().account_confirmation_success,this.setAuthHeader(this.buildAuthToken(s,t,u)),n.url(n.path()||"/")):i.get("auth_header")&&(this.header=i.get("auth_header"),e.defaults.headers.common.Authorization=this.header),this.header?this.validateToken():(this.rejectDfd({reason:"unauthorized",errors:["No credentials"]}),o.$broadcast("auth:invalid")))),this.dfd.promise},validateToken:function(){return e.get(this.apiUrl()+t.tokenValidationPath).success(function(t){return function(e){return t.handleValidAuth(e.data),t.firstTimeLogin&&o.$broadcast("auth:email-confirmation-success",t.user),t.mustResetPassword?o.$broadcast("auth:password-reset-prompt",t.user):o.$broadcast("auth:validated",t.user)}}(this)).error(function(t){return function(){return t.dfd.reject({reason:"unauthorized",errors:["Invalid/expired credentials"]}),a(function(){return t.dfd=null},0)}}(this))},invalidateTokens:function(){var t,r,n;n=this.user;for(t in n)r=n[t],delete this.user[t];return this.header=null,delete s.auth_header,e.defaults.headers.common.Authorization=""},signOut:function(){return e["delete"](this.apiUrl()+t.signOutUrl).success(function(t){return function(){return t.invalidateTokens(),o.$broadcast("auth:logout-success")}}(this)).error(function(){return function(t){return o.$broadcast("auth:logout-error",t)}}(this))},handleValidAuth:function(t,e){return null==e&&(e=!1),null!=this.t&&a.cancel(this.t),angular.extend(this.user,t),e&&this.setAuthHeader(this.buildAuthToken(this.user.auth_token,this.user.client_id,this.user.uid)),this.resolveDfd()},cancelAuth:function(t){return a.cancel(this.t),this.rejectDfd(t),o.$broadcast("auth:login-error",t)},buildAuthToken:function(t,e,r){return"token="+t+" client="+e+" uid="+r},setAuthHeader:function(t){return this.header=e.defaults.headers.common.Authorization=t,i.put("auth_header",t)},useExternalWindow:function(){return!u.isOldIE()},apiUrl:function(){return null==this._apiUrl&&(this._apiUrl=t.proxyIf()?"/proxy":t.apiUrl),this._apiUrl}}}}(this)]}}).config(function(t){var e,r,n,s,i;return t.interceptors.push(function(t){return{response:function(e){return t.invoke(function(t,r){return e.headers("Authorization")?r.setAuthHeader(e.headers("Authorization")):void 0}),e}}}),null==(e=t.defaults.headers).get&&(e.get={}),null==(r=t.defaults.headers).post&&(r.post={}),null==(n=t.defaults.headers).put&&(n.put={}),null==(s=t.defaults.headers).patch&&(s.patch={}),null==(i=t.defaults.headers)["delete"]&&(i["delete"]={}),t.defaults.headers.get["If-Modified-Since"]="0",t.defaults.headers.post["If-Modified-Since"]="0",t.defaults.headers.put["If-Modified-Since"]="0",t.defaults.headers.patch["If-Modified-Since"]="0",t.defaults.headers["delete"]["If-Modified-Since"]="0"}).run(function(t,e,r){return e.addEventListener&&e.addEventListener("message",function(){return function(e){return"deliverCredentials"===e.data.message&&(e.source.close(),delete e.data.message,t.handleValidAuth(e.data,!0),r.$broadcast("auth:login-success",e.data)),"authFailure"===e.data.message?(e.source.close(),t.cancelAuth({reason:"unauthorized",errors:[e.data.error]})):void 0}}(this)),r.user=t.user,r.authenticate=function(e){return t.authenticate(e)},r.signOut=function(){return t.signOut()},r.submitRegistration=function(e){return t.submitRegistration(e)},r.submitLogin=function(e){return t.submitLogin(e)},r.requestPasswordReset=function(e){return t.requestPasswordReset(e)},r.updatePassword=function(e){return t.updatePassword(e)},t.validateUser()}),window.isOldIE=function(){var t,e,r;return e=!1,t=navigator.userAgent.toLowerCase(),t&&-1!==t.indexOf("msie")&&(r=parseInt(t.split("msie")[1]),10>r&&(e=!0)),e};