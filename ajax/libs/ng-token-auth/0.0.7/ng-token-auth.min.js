angular.module("ng-token-auth",["ngCookies"]).provider("$auth",function(){var t;return t={apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",confirmationSuccessUrl:window.location.href,tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}},{configure:function(e){return angular.extend(t,e)},$get:["$http","$q","$location","$cookies","$cookieStore","$window","$timeout","$rootScope",function(){return function(e,n,i,r,u,o,a,s){return{header:null,dfd:null,config:t,user:{},submitRegistration:function(n){return console.log("submitting registration",n),angular.extend(n,{confirm_success_url:t.confirmationSuccessUrl}),e.post(this.apiUrl()+t.emailRegistrationPath,n)},submitLogin:function(i){return console.log("params",i),this.dfd=n.defer(),e.post(this.apiUrl()+t.emailSignInPath,i).success(function(t){return function(e){return console.log("this",t),console.log("resp",e.data),t.handleValidAuth(e.data)}}(this)).error(function(t){return function(){return t.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]})}}(this)),this.dfd.promise},authenticate:function(t){var e;return null==this.dfd&&(this.dfd=n.defer(),e=this.openAuthWindow(t),this.requestCredentials(e)),this.dfd},openAuthWindow:function(e){return o.open(this.apiUrl()+t.authProviderPaths[e])},requestCredentials:function(t){return t.closed?this.rejectDfd({reason:"unauthorized",errors:["User canceled login"]}):(t.postMessage("requestCredentials","*"),this.t=a(function(e){return function(){return e.requestCredentials(t)}}(this),500))},rejectDfd:function(t){return this.invalidateTokens(),null!=this.dfd?(this.dfd.reject(t),a(function(t){return function(){return t.dfd=null,s.$broadcast("auth:failure")}}(this),0)):void 0},resolveDfd:function(){return this.dfd.resolve({id:this.user.id}),a(function(t){return function(){return t.dfd=null,s.$broadcast("auth:success"),s.$digest()}}(this),0)},validateUser:function(){var t,r,o;return null==this.dfd&&(this.dfd=n.defer(),this.header&&this.user.id?this.resolveDfd():(void 0!==i.search().token?(r=i.search().token,t=i.search().client_id,o=i.search().uid,this.setAuthHeader(this.buildAuthToken(r,client_id,o))):u.get("auth_header")&&(this.header=u.get("auth_header"),e.defaults.headers.common.Authorization=this.header),this.header?this.validateToken():this.rejectDfd({reason:"unauthorized",errors:["No credentials"]}))),this.dfd.promise},validateToken:function(){return e.get(this.apiUrl()+t.tokenValidationPath).success(function(t){return function(e){return t.handleValidAuth(e.data)}}(this)).error(function(t){return function(){return t.dfd.reject({reason:"unauthorized",errors:["Invalid/expired credentials"]}),a(function(){return t.dfd=null},0)}}(this))},invalidateTokens:function(){var t,n,i;i=this.user;for(t in i)n=i[t],delete this.user[t];return this.header=null,delete r.auth_header,e.defaults.headers.common.Authorization=""},signOut:function(){return e["delete"](this.apiUrl()+t.signOutUrl).success(function(t){return function(){return t.invalidateTokens()}}(this)).error(function(t){return function(){return t.invalidateTokens()}}(this))},handleValidAuth:function(t,e){return null==e&&(e=!1),null!=this.t&&a.cancel(this.t),angular.extend(this.user,t),e&&this.setAuthHeader(this.buildAuthToken(this.user.auth_token,this.user.client_id,this.user.uid)),this.resolveDfd()},cancelAuth:function(){return a.cancel(this.t),s.$broadcast("auth:cancelled"),this.rejectDfd()},buildAuthToken:function(t,e,n){return"token="+t+" client="+e+" uid="+n},setAuthHeader:function(t){return this.header=e.defaults.headers.common.Authorization=t,u.put("auth_header",t)},apiUrl:function(){return null==this._apiUrl&&(this._apiUrl=t.proxyIf()?"/proxy":t.apiUrl),this._apiUrl}}}}(this)]}}).config(function(t){return t.interceptors.push(function(t){return{response:function(e){return t.invoke(function(t,n){return n.setAuthHeader(e.headers("Authorization"))}),e}}})}).run(function(t,e,n){return e.addEventListener("message",function(){return function(e){return"deliverCredentials"===e.data.message&&(e.source.close(),delete e.data.message,t.handleValidAuth(e.data,!0)),"authFailure"===e.data.message?(e.source.close(),t.cancelAuth()):void 0}}(this)),n.user=t.user,n.githubLogin=function(){return t.authenticate("github")},n.facebookLogin=function(){return t.authenticate("facebook")},n.googleLogin=function(){return t.authenticate("google")},n.authenticate=function(e){return t.authenticate(e)},n.signOut=function(){return t.signOut()},n.submitRegistration=function(e){return t.submitRegistration(e)},n.submitLogin=function(e){return t.submitLogin(e)},t.validateUser()});