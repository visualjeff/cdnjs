angular.module("ng-token-auth",["ngCookies"]).provider("$auth",function(){var t;return t={apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",confirmationSuccessUrl:window.location.href,passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",passwordResetSuccessUrl:window.location.href,tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",validateOnPageLoad:!0,forceHardRedirect:!1,storage:"cookies",tokenFormat:{"access-token":"{{ token }}","token-type":"Bearer",client:"{{ clientId }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},parseExpiry:function(t){return 1e3*parseInt(t.expiry,10)||null},handleLoginResponse:function(t){return t.data},handleTokenValidationResponse:function(t){return t.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}},{configure:function(e){return angular.extend(t,e)},$get:["$http","$q","$location","$cookies","$cookieStore","$window","$timeout","$rootScope","$interpolate",function(){return function(e,r,n,s,i,a,u,o,d){return{header:null,dfd:null,config:t,user:{},mustResetPassword:!1,listener:null,initialize:function(){return this.initializeListeners(),this.addScopeMethods()},initializeListeners:function(){return this.listener=this.handlePostMessage.bind(this),a.addEventListener?a.addEventListener("message",this.listener,!1):void 0},cancel:function(t){return null!=this.t&&u.cancel(this.t),null!=this.dfd&&this.rejectDfd(t),u(function(t){return function(){return t.t=null}}(this),0)},destroy:function(){return this.cancel(),a.removeEventListener?a.removeEventListener("message",this.listener,!1):void 0},handlePostMessage:function(t){var e;return"deliverCredentials"===t.data.message&&(delete t.data.message,this.handleValidAuth(t.data,!0),o.$broadcast("auth:login-success",t.data)),"authFailure"===t.data.message?(e={reason:"unauthorized",errors:[t.data.error]},this.cancel(e),o.$broadcast("auth:login-error",e)):void 0},addScopeMethods:function(){return o.user=this.user,o.authenticate=function(t){return function(e){return t.authenticate(e)}}(this),o.signOut=function(t){return function(){return t.signOut()}}(this),o.submitRegistration=function(t){return function(e){return t.submitRegistration(e)}}(this),o.submitLogin=function(t){return function(e){return t.submitLogin(e)}}(this),o.requestPasswordReset=function(t){return function(e){return t.requestPasswordReset(e)}}(this),o.updatePassword=function(t){return function(e){return t.updatePassword(e)}}(this),t.validateOnPageLoad?this.validateUser():void 0},submitRegistration:function(r){return angular.extend(r,{confirm_success_url:t.confirmationSuccessUrl}),e.post(this.apiUrl()+t.emailRegistrationPath,r).success(function(){return o.$broadcast("auth:registration-email-success",r)}).error(function(t){return o.$broadcast("auth:registration-email-error",t)})},submitLogin:function(r){return this.initDfd(),e.post(this.apiUrl()+t.emailSignInPath,r).success(function(e){return function(r){var n;return n=t.handleLoginResponse(r),e.handleValidAuth(n),o.$broadcast("auth:login-success",e.user)}}(this)).error(function(t){return function(e){return t.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]}),o.$broadcast("auth:login-error",e)}}(this)),this.dfd.promise},requestPasswordReset:function(r){return r.redirect_url=t.passwordResetSuccessUrl,e.post(this.apiUrl()+t.passwordResetPath,r).success(function(){return o.$broadcast("auth:password-reset-request-success",r)}).error(function(t){return o.$broadcast("auth:password-reset-request-error",t)})},updatePassword:function(r){return e.put(this.apiUrl()+t.passwordUpdatePath,r).success(function(t){return function(e){return o.$broadcast("auth:password-change-success",e),t.mustResetPassword=!1}}(this)).error(function(t){return o.$broadcast("auth:password-change-error",t)})},authenticate:function(t){return null==this.dfd&&(this.initDfd(),this.openAuthWindow(t)),this.dfd.promise},openAuthWindow:function(t){var e;return e=this.buildAuthUrl(t),this.useExternalWindow()?this.requestCredentials(a.open(e)):n.replace(e)},buildAuthUrl:function(e){var r;return r=t.apiUrl,r+=t.authProviderPaths[e],r+="?auth_origin_url=",r+=n.href},requestCredentials:function(t){return t.closed?(this.cancel({reason:"unauthorized",errors:["User canceled login"]}),o.$broadcast("auth:window-closed")):(t.postMessage("requestCredentials","*"),this.t=u(function(e){return function(){return e.requestCredentials(t)}}(this),500))},resolveDfd:function(){return this.dfd.resolve({id:this.user.id}),u(function(t){return function(){return t.dfd=null,o.$$phase?void 0:o.$digest()}}(this),0)},validateUser:function(){var t,e,r;return null==this.dfd&&(this.initDfd(),this.headers&&this.user.id?this.resolveDfd():(void 0!==n.search().token?(e=n.search().token,t=n.search().client_id,r=n.search().uid,this.mustResetPassword=n.search().reset_password,this.firstTimeLogin=n.search().account_confirmation_success,this.setAuthHeaders(this.buildAuthHeaders({token:e,clientId:t,uid:r})),n.url(n.path()||"/")):this.retrieveData("auth_headers")&&(this.headers=this.retrieveData("auth_headers")),this.headers?this.validateToken():(this.rejectDfd({reason:"unauthorized",errors:["No credentials"]}),o.$broadcast("auth:invalid")))),this.dfd.promise},validateToken:function(){return this.tokenHasExpired()?this.rejectDfd({reason:"unauthorized",errors:["Expired credentials"]}):e.get(this.apiUrl()+t.tokenValidationPath).success(function(e){return function(r){var n;return n=t.handleTokenValidationResponse(r),e.handleValidAuth(n),e.firstTimeLogin&&o.$broadcast("auth:email-confirmation-success",e.user),e.mustResetPassword&&o.$broadcast("auth:password-reset-confirm-success",e.user),o.$broadcast("auth:validation-success",e.user)}}(this)).error(function(t){return function(e){return t.firstTimeLogin&&o.$broadcast("auth:email-confirmation-error",e),t.mustResetPassword&&o.$broadcast("auth:password-reset-confirm-error",e),o.$broadcast("auth:validation-error",e),t.rejectDfd({reason:"unauthorized",errors:e.errors})}}(this))},tokenHasExpired:function(){var t,e;return t=this.getExpiry(),e=(new Date).getTime(),this.headers&&t?t&&e>t:null},getExpiry:function(){return t.parseExpiry(this.headers)},invalidateTokens:function(){var t,e,r;r=this.user;for(t in r)e=r[t],delete this.user[t];return this.headers=null,delete s.auth_headers},signOut:function(){return e["delete"](this.apiUrl()+t.signOutUrl).success(function(t){return function(){return t.invalidateTokens(),o.$broadcast("auth:logout-success")}}(this)).error(function(){return function(t){return o.$broadcast("auth:logout-error",t)}}(this))},handleValidAuth:function(t,e){return null==e&&(e=!1),null!=this.t&&u.cancel(this.t),angular.extend(this.user,t),e&&this.setAuthHeaders(this.buildAuthHeaders({token:this.user.auth_token,clientId:this.user.client_id,uid:this.user.uid})),this.resolveDfd()},buildAuthHeaders:function(e){var r,n,s,i;r={},i=t.tokenFormat;for(n in i)s=i[n],r[n]=d(s)(e);return r},persistData:function(e,r){switch(t.storage){case"localStorage":return a.localStorage.setItem(e,JSON.stringify(r));default:return i.put(e,r)}},retrieveData:function(e){switch(t.storage){case"localStorage":return JSON.parse(a.localStorage.getItem(e));default:return i.get(e)}},setAuthHeaders:function(t){return this.headers=angular.extend(this.headers||{},t),this.persistData("auth_headers",this.headers)},useExternalWindow:function(){return!(t.forceHardRedirect||a.isOldIE())},initDfd:function(){return this.dfd=r.defer()},rejectDfd:function(t){return this.invalidateTokens(),null!=this.dfd?(this.dfd.reject(t),u(function(t){return function(){return t.dfd=null}}(this),0)):void 0},apiUrl:function(){return t.proxyIf()?t.proxyUrl:t.apiUrl}}}}(this)]}}).config(["$httpProvider",function(t){var e;return t.interceptors.push(["$injector",function(t){return{request:function(e){return t.invoke(["$http","$auth",function(t,r){var n,s,i,a;if(e.url.match(r.config.apiUrl)){i=r.headers,a=[];for(n in i)s=i[n],a.push(e.headers[n]=s);return a}}]),e},response:function(e){return t.invoke(["$http","$auth",function(t,r){var n,s,i,a;s={},a=r.config.tokenFormat;for(n in a)i=a[n],e.headers(n)&&(s[n]=e.headers(n));return r.setAuthHeaders(s)}]),e}}}]),e=["get","post","put","patch","delete"],angular.forEach(e,function(e){var r;return null==(r=t.defaults.headers)[e]&&(r[e]=e),t.defaults.headers[e]["If-Modified-Since"]="0"})}]).run(["$auth","$window","$rootScope",function(t){return t.initialize()}]),window.isOldIE=function(){var t,e,r;return e=!1,t=navigator.userAgent.toLowerCase(),t&&-1!==t.indexOf("msie")&&(r=parseInt(t.split("msie")[1]),10>r&&(e=!0)),e};