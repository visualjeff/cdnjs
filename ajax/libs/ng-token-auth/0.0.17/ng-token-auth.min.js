angular.module("ng-token-auth",["ngCookies"]).provider("$auth",function(){var t;return t={apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",confirmationSuccessUrl:window.location.href,passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",passwordResetSuccessUrl:window.location.href,tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",validateOnPageLoad:!0,forceHardRedirect:!1,authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}},{configure:function(e){return angular.extend(t,e)},$get:["$http","$q","$location","$cookies","$cookieStore","$window","$timeout","$rootScope",function(){return function(e,r,n,i,s,u,a,o){return{header:null,dfd:null,config:t,user:{},mustResetPassword:!1,listener:null,initialize:function(){return this.initializeListeners(),this.addScopeMethods()},initializeListeners:function(){return this.listener=this.handlePostMessage.bind(this),u.addEventListener?u.addEventListener("message",this.listener,!1):void 0},cancel:function(t){return null!=this.t&&a.cancel(this.t),null!=this.dfd&&this.rejectDfd(t),a(function(t){return function(){return t.t=null}}(this),0)},destroy:function(){return this.cancel(),u.removeEventListener?u.removeEventListener("message",this.listener,!1):void 0},handlePostMessage:function(t){var e;return"deliverCredentials"===t.data.message&&(delete t.data.message,this.handleValidAuth(t.data,!0),o.$broadcast("auth:login-success",t.data)),"authFailure"===t.data.message?(e={reason:"unauthorized",errors:[t.data.error]},this.cancel(e),o.$broadcast("auth:login-error",e)):void 0},addScopeMethods:function(){return o.user=this.user,o.authenticate=function(t){return function(e){return t.authenticate(e)}}(this),o.signOut=function(t){return function(){return t.signOut()}}(this),o.submitRegistration=function(t){return function(e){return t.submitRegistration(e)}}(this),o.submitLogin=function(t){return function(e){return t.submitLogin(e)}}(this),o.requestPasswordReset=function(t){return function(e){return t.requestPasswordReset(e)}}(this),o.updatePassword=function(t){return function(e){return t.updatePassword(e)}}(this),this.config.validateOnPageLoad?this.validateUser():void 0},submitRegistration:function(r){return angular.extend(r,{confirm_success_url:t.confirmationSuccessUrl}),e.post(this.apiUrl()+t.emailRegistrationPath,r).success(function(){return o.$broadcast("auth:registration-email-success",r)}).error(function(t){return o.$broadcast("auth:registration-email-error",t)})},submitLogin:function(r){return this.initDfd(),e.post(this.apiUrl()+t.emailSignInPath,r).success(function(t){return function(e){return t.handleValidAuth(e.data),o.$broadcast("auth:login-success",t.user)}}(this)).error(function(t){return function(e){return t.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]}),o.$broadcast("auth:login-error",e)}}(this)),this.dfd.promise},requestPasswordReset:function(r){return r.redirect_url=t.passwordResetSuccessUrl,e.post(this.apiUrl()+t.passwordResetPath,r).success(function(){return o.$broadcast("auth:password-reset-request-success",r)}).error(function(t){return o.$broadcast("auth:password-reset-request-error",t)})},updatePassword:function(r){return e.put(this.apiUrl()+t.passwordUpdatePath,r).success(function(t){return function(e){return o.$broadcast("auth:password-change-success",e),t.mustResetPassword=!1}}(this)).error(function(t){return o.$broadcast("auth:password-change-error",t)})},authenticate:function(t){return null==this.dfd&&(this.initDfd(),this.openAuthWindow(t)),this.dfd.promise},openAuthWindow:function(t){var e;return e=this.buildAuthUrl(t),this.useExternalWindow()?this.requestCredentials(u.open(e)):n.replace(e)},buildAuthUrl:function(e){var r;return r=t.apiUrl,r+=t.authProviderPaths[e],r+="?auth_origin_url=",r+=n.href},requestCredentials:function(t){return t.closed?(this.cancel({reason:"unauthorized",errors:["User canceled login"]}),o.$broadcast("auth:window-closed")):(t.postMessage("requestCredentials","*"),this.t=a(function(e){return function(){return e.requestCredentials(t)}}(this),500))},resolveDfd:function(){return this.dfd.resolve({id:this.user.id}),a(function(t){return function(){return t.dfd=null,o.$$phase?void 0:o.$digest()}}(this),0)},validateUser:function(){var t,r,i;return null==this.dfd&&(this.initDfd(),this.header&&this.user.id?this.resolveDfd():(void 0!==n.search().token?(r=n.search().token,t=n.search().client_id,i=n.search().uid,this.mustResetPassword=n.search().reset_password,this.firstTimeLogin=n.search().account_confirmation_success,this.setAuthHeader(this.buildAuthToken(r,t,i)),n.url(n.path()||"/")):s.get("auth_header")&&(this.header=s.get("auth_header"),e.defaults.headers.common.Authorization=this.header),this.header?this.validateToken():(this.rejectDfd({reason:"unauthorized",errors:["No credentials"]}),o.$broadcast("auth:invalid")))),this.dfd.promise},validateToken:function(){return e.get(this.apiUrl()+t.tokenValidationPath).success(function(t){return function(e){return t.handleValidAuth(e.data),t.firstTimeLogin&&o.$broadcast("auth:email-confirmation-success",t.user),t.mustResetPassword&&o.$broadcast("auth:password-reset-confirm-success",t.user),o.$broadcast("auth:validation-success",t.user)}}(this)).error(function(t){return function(e){return t.firstTimeLogin&&o.$broadcast("auth:email-confirmation-error",e),t.mustResetPassword&&o.$broadcast("auth:password-reset-confirm-error",e),o.$broadcast("auth:validation-error",e),t.rejectDfd({reason:"unauthorized",errors:["Invalid/expired credentials"]})}}(this))},invalidateTokens:function(){var t,r,n;n=this.user;for(t in n)r=n[t],delete this.user[t];return this.header=null,delete i.auth_header,e.defaults.headers.common.Authorization=""},signOut:function(){return e["delete"](this.apiUrl()+t.signOutUrl).success(function(t){return function(){return t.invalidateTokens(),o.$broadcast("auth:logout-success")}}(this)).error(function(){return function(t){return o.$broadcast("auth:logout-error",t)}}(this))},handleValidAuth:function(t,e){return null==e&&(e=!1),null!=this.t&&a.cancel(this.t),angular.extend(this.user,t),e&&this.setAuthHeader(this.buildAuthToken(this.user.auth_token,this.user.client_id,this.user.uid)),this.resolveDfd()},buildAuthToken:function(t,e,r){return"token="+t+" client="+e+" uid="+r},setAuthHeader:function(t){return this.header=e.defaults.headers.common.Authorization=t,s.put("auth_header",t)},useExternalWindow:function(){return!(t.forceHardRedirect||u.isOldIE())},initDfd:function(){return this.dfd=r.defer()},rejectDfd:function(t){return this.invalidateTokens(),null!=this.dfd?(this.dfd.reject(t),a(function(t){return function(){return t.dfd=null}}(this),0)):void 0},apiUrl:function(){return t.proxyIf()?t.proxyUrl:t.apiUrl}}}}(this)]}}).config(function(t){var e;return t.interceptors.push(function(t){return{response:function(e){return t.invoke(function(t,r){return e.headers("Authorization")?r.setAuthHeader(e.headers("Authorization")):void 0}),e}}}),e=["get","post","put","patch","delete"],angular.forEach(e,function(e){var r;return null==(r=t.defaults.headers)[e]&&(r[e]=e),t.defaults.headers[e]["If-Modified-Since"]="0"})}).run(function(t){return t.initialize()}),window.isOldIE=function(){var t,e,r;return e=!1,t=navigator.userAgent.toLowerCase(),t&&-1!==t.indexOf("msie")&&(r=parseInt(t.split("msie")[1]),10>r&&(e=!0)),e};