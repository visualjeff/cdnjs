!function(a){function b(a,b,c){t(a.position,b.position,z);var d=a.shape.radius,e=b.shape.radius;w(z)<(d+e)*(d+e)&&(c.push(a),c.push(b))}function c(a,b,c){t(a.position,b.position,z),x.setFromRotation(A,b.angle),x.vectorMultiply(A,C,B),u(z,B)<=a.shape.radius&&(c.push(a),c.push(b))}function d(a,b,c){c.push(a),c.push(b)}function e(b,c,d,e){var f=e.length?e.pop():new a.ContactEquation(b,c);f.bi=b,f.bj=c,t(c.position,b.position,f.ni),q.normalize(f.ni,f.ni),s(f.ni,b.shape.radius,f.ri),s(f.ni,-c.shape.radius,f.rj),d.push(f)}function f(){}function g(b,c,d,e){var f=D,g=e.length?e.pop():new a.ContactEquation(c,b);g.bi=c,g.bj=b;var h=E,i=F;x.setFromRotation(f,c.angle),x.vectorMultiply(f,C,g.ni),q.scale(g.ni,-b.shape.radius,g.rj),q.subtract(b.position,c.position,h);var j=q.dot(g.ni,h);q.scale(g.ni,j,i),q.subtract(h,i,g.ri),d.push(g)}function h(){return performance.now?performance.now():performance.webkitNow?performance.webkitNow():((new Date).getTime(),void 0)}var a={},i=0,j=0,k=Float32Array,l=Math.cos,m=Math.abs,n=Math.sin,o=Math.sqrt,p=Math.floor;a.tVec2={},a.oVec2={},a.tVec2.create=function(a,b){i++;var c=new k(2);return c[0]=a||0,c[1]=b||0,c},a.oVec2.create=function(a,b){return{x:a||0,y:b||0}},a.tVec2.set=function(a,b,c){a[0]=b,a[1]=c},a.oVec2.set=function(a,b,c){a.x=b,a.y=c},a.tVec2.copy=function(a,b){b[0]=a[0],b[1]=a[1]},a.oVec2.copy=function(a,b){b.x=a.x,b.y=a.y},a.tVec2.add=function(a,b,c){c[0]=a[0]+b[0],c[1]=a[1]+b[1]},a.oVec2.add=function(a,b,c){c.x=a.x+b.x,c.y=a.y+b.y},a.tVec2.subtract=function(a,b,c){c[0]=a[0]-b[0],c[1]=a[1]-b[1]},a.oVec2.subtract=function(a,b,c){c.x=a.x-b.x,c.y=a.y-b.y},a.tVec2.scale=function(a,b,c){c[0]=a[0]*b,c[1]=a[1]*b},a.oVec2.scale=function(a,b,c){c.x=a.x*b,c.y=a.y*b},a.tVec2.normalize=function(b,c){var d=1/a.tVec2.norm(b);c[0]=b[0]*d,c[1]=b[1]*d},a.oVec2.normalize=function(b,c){var d=1/a.oVec2.norm(b);c.x=b.x*d,c.y=b.y*d},a.tVec2.norm=function(a){return o(a[0]*a[0]+a[1]*a[1])},a.oVec2.norm=function(a){return o(a.x*a.x+a.y*a.y)},a.tVec2.norm2=function(a){return a[0]*a[0]+a[1]*a[1]},a.oVec2.norm2=function(a){return a.x*a.x+a.y*a.y},a.tVec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},a.oVec2.dot=function(a,b){return a.x*b.x+a.y*b.y},a.tVec2.cross=function(a,b){return a[0]*b[1]-a[1]*b[0]},a.oVec2.cross=function(a,b){return a.x*b.y-a.y*b.x},a.tVec2.rotate=function(a,b,c){var d=l(b),e=n(b);c[0]=d*a[0]-e*a[1],c[1]=e*a[0]+d*a[1]},a.oVec2.rotate=function(a,b,c){var d=l(b),e=n(b);c.x=d*a.x-e*a.y,c.y=e*a.x+d*a.y},a.tVec2.getX=function(a){return a[0]},a.tVec2.getY=function(a){return a[1]},a.oVec2.getX=function(a){return a.x},a.oVec2.getY=function(a){return a.y};var q=a.V=a.tVec2,r=q.add,s=q.scale,t=q.subtract,u=q.dot,v=q.cross,w=q.norm2;q.copy,a.tMat2={},a.oMat2={},a.tMat2.create=function(a,b,c,d){j++;var e=new k(4);return e[0]=a||0,e[1]=b||0,e[2]=c||0,e[3]=d||0,e},a.oMat2.create=function(a,b,c,d){return{e11:a||0,e12:b||0,e21:c||0,e22:d||0}},a.tMat2.vectorMultiply=function(a,b,c){c[0]=a[0]*b[0]+a[1]*b[1],c[1]=a[2]*b[0]+a[3]*b[1]},a.oMat2.vectorMultiply=function(a,b,c){c.x=a.e11*b.x+a.e12*b.y,c.y=a.e21*b.x+a.e22*b.y},a.tMat2.setIdentity=function(a){a[0]=1,a[1]=0,a[2]=0,a[3]=1},a.oMat2.setIdentity=function(a){a.e11=1,a.e12=0,a.e21=0,a.e22=1},a.tMat2.setFromRotation=function(a,b){a[0]=l(b),a[1]=-n(b),a[2]=n(b),a[3]=l(b)},a.oMat2.setFromRotation=function(a,b){a.e11=l(b),a.e12=-n(b),a.e21=n(b),a.e22=l(b)};var x=a.M=a.tMat2;a.Shape=function(){},a.Particle=function(){a.Shape.apply(this)},a.Circle=function(b){a.Shape.apply(this),this.radius=b||1},a.Plane=function(){a.Shape.apply(this)},a.Spring=function(a,b,c){c=c||{},this.restLength=c.restLength||1,this.stiffness=c.stiffness||100,this.damping=c.damping||1,this.bodyA=a,this.bodyB=b},a.Body=function(a){a=a||{},this.shape=a.shape,this.mass=a.mass||0,this.invMass=this.mass>0?1/this.mass:0,this.inertia=a.inertia||this.mass,this.invInertia=this.invMass,this.position=a.position||q.create(),this.velocity=a.velocity||q.create(),this.vlambda=q.create(),this.wlambda=0,this.angle=a.angle||0,this.angularVelocity=a.angularVelocity||0,this.force=a.force||q.create(),this.angularForce=a.angularForce||0};var y=q.create();a.Body.prototype.applyForce=function(a,b){var c=y;q.subtract(b,this.position,c),q.add(this.force,a,this.force);var d=q.cross(c,a);this.angularForce+=d};var z=q.create(),A=x.create(),B=q.create(),C=q.create(0,1),D=x.create(),E=q.create(),F=q.create(),G=q.create(),H=q.create(),I=q.create(),J=q.create(),K=q.create(),L=q.create();a.Broadphase=function(){},a.Broadphase.prototype.getCollisionPairs=function(){throw new Error("getCollisionPairs must be implemented in a subclass!")},a.NaiveBroadphase=function(){a.Broadphase.apply(this),this.getCollisionPairs=function(e){for(var f=e.collidingBodies,g=[],h=0,i=f.length;h!==i;h++){var j=f[h],k=j.shape;if(void 0!==k)for(var l=0;l!==h;l++){var m=f[l],n=m.shape;void 0!==n&&(k instanceof a.Circle?n instanceof a.Circle?b(j,m,g):n instanceof a.Particle?d(j,m,g):n instanceof a.Plane&&c(j,m,g):k instanceof a.Particle?n instanceof a.Circle&&d(m,j,g):k instanceof a.Plane&&n instanceof a.Circle&&c(m,j,g))}}return g}},a.NaiveBroadphase.prototype=new a.Broadphase,a.GridBroadphase=function(e,f,g,h,i,j){a.Broadphase.apply(this),i=i||10,j=j||10;var k=(f-e)/i,l=(h-g)/j,m=a.Plane,n=a.Circle,o=a.Particle;this.getCollisionPairs=function(r){for(var s=[],t=r.collidingBodies,u=u=t.length,v=[],w=i*j,x=0;w>x;x++)v.push([]);for(var y=i/(f-e),z=j/(h-g),x=0;x!==u;x++){var A=t[x],B=A.shape;if(void 0!==B)if(B instanceof n)for(var C=q.getX(A.position),D=q.getY(A.position),E=B.radius,F=p(y*(C-E-e)),G=p(z*(D-E-g)),H=p(y*(C+E-e)),I=p(z*(D+E-g)),J=F;H>=J;J++)for(var K=G;I>=K;K++){var L=J,M=K;L*(j-1)+M>=0&&w>L*(j-1)+M&&v[L*(j-1)+M].push(A)}else{if(!(B instanceof m))throw new Error("Shape not supported in GridBroadphase!");if(0==A.angle)for(var D=q.getY(A.position),J=0;J!==w&&D>g+l*(J-1);J++)for(var K=0;i>K;K++){var L=K,M=p(z*(l*J-g));v[L*(j-1)+M].push(A)}else if(A.angle==.5*Math.PI)for(var C=q.getX(A.position),J=0;J!==w&&C>e+k*(J-1);J++)for(var K=0;j>K;K++){var M=K,L=p(y*(k*J-e));v[L*(j-1)+M].push(A)}else for(var J=0;J!==w;J++)v[J].push(A)}}for(var x=0;x!==w;x++)for(var N=v[x],J=0,O=N.length;J!==O;J++)for(var A=N[J],B=A.shape,K=0;K!==J;K++){var P=N[K],Q=P.shape;B instanceof a.Circle?Q instanceof n?b(A,P,s):Q instanceof o?d(A,P,s):Q instanceof m&&c(A,P,s):B instanceof o?Q instanceof n&&d(P,A,s):B instanceof m&&Q instanceof n&&c(P,A,s)}return s}},a.GridBroadphase.prototype=new a.Broadphase,a.World=function(b){b=b||{},this.springs=[],this.bodies=[],this.solver=b.solver||new a.GSSolver,this.contacts=[],this.oldContacts=[],this.collidingBodies=[],this.gravity=b.gravity||q.create(0,-9.78),this.doProfiling=b.doProfiling||!1,this.lastStepTime=0,this.broadphase=b.broadphase||new a.NaiveBroadphase},a.World.prototype.step=function(b){var c,d,k=this.doProfiling,l=this.springs.length,m=this.springs,n=this.bodies,o=(this.collidingBodies,this.gravity),p=this.solver,u=this.bodies.length,v=this.broadphase;k&&(c=h(),i=0,j=0);for(var w=0;w!==u;w++){var x=n[w].force;r(x,o,x)}for(var w=0;w!==l;w++){var y=m[w],z=y.stiffness,A=y.damping,B=y.restLength,C=y.bodyA,D=y.bodyB,E=G,F=H,M=I,N=J;t(C.position,D.position,E),t(C.velocity,D.velocity,M);var O=q.norm(E);q.normalize(E,F),s(F,z*(O-B)+A*q.dot(M,F),N),t(C.force,N,C.force),r(D.force,N,D.force)}for(var P=v.getCollisionPairs(this),Q=this.contacts.concat(this.oldContacts),R=this.contacts=[],S=a.Circle,T=a.Plane,U=a.Particle,w=0,V=P.length;w!==V;w+=2){var W=P[w],X=P[w+1],Y=W.shape,Z=X.shape;Y instanceof a.Circle?Z instanceof S?e(W,X,R,Q):Z instanceof U?f(W,X,R,Q):Z instanceof T&&g(W,X,R,Q):Y instanceof U?Z instanceof S&&f(X,W,R,Q):Y instanceof T&&Z instanceof S&&g(X,W,R,Q)}this.oldContacts=Q;for(var w=0,$=R.length;w!==$;w++)p.addEquation(R[w]);p.solve(b,this),p.removeAllEquations();for(var _=K,ab=L,w=0;w!==u;w++){var bb=n[w];if(bb.mass>0){var cb=1/bb.mass,N=bb.force,db=bb.position,eb=bb.velocity;bb.angularVelocity+=bb.angularForce*bb.invInertia*b,bb.angle+=bb.angularVelocity*b,s(N,b*cb,_),r(_,eb,eb),s(eb,b,ab),r(db,ab,db)}}for(var w=0;w!==u;w++){var W=n[w];q.set(W.force,0,0),W.angularForce=0}k&&(d=h(),this.lastStepTime=d-c,this.vecCreations=i,this.matCreations=j)},a.World.prototype.addSpring=function(a){this.springs.push(a)},a.World.prototype.removeSpring=function(a){var b=this.springs.indexOf(a);-1===b&&this.springs.splice(b,1)},a.World.prototype.addBody=function(a){this.bodies.push(a),this.collidingBodies.push(a)},a.World.prototype.removeBody=function(a){var b=this.bodies.indexOf(a);-1===b&&this.bodies.splice(b,1)},a.Solver=function(){this.equations=[]},a.Solver.prototype.solve=function(){return 0},a.Solver.prototype.addEquation=function(a){this.equations.push(a)},a.Solver.prototype.removeEquation=function(a){var b=this.equations.indexOf(a);-1!=b&&this.equations.splice(b,1)},a.Solver.prototype.removeAllEquations=function(){this.equations=[]},a.GSSolver=function(){a.Solver.call(this),this.iterations=10,this.h=1/60,this.k=1e7,this.d=6,this.a=0,this.b=0,this.eps=0,this.tolerance=0,this.setSpookParams(this.k,this.d),this.debug=!1,this.arrayStep=30,this.lambda=new k(this.arrayStep),this.Bs=new k(this.arrayStep),this.invCs=new k(this.arrayStep)},a.GSSolver.prototype=new a.Solver,a.GSSolver.prototype.setSpookParams=function(a,b){var c=this.h;this.k=a,this.d=b,this.a=4/(c*(1+4*b)),this.b=4*b/(1+4*b),this.eps=4/(c*c*a*(1+4*b))},a.GSSolver.prototype.solve=function(a,b){var c=(this.d,this.k,0),d=this.iterations,e=this.tolerance*this.tolerance,f=this.a,g=this.b,h=this.eps,i=this.equations,j=i.length,l=b.bodies,n=b.bodies.length,o=a;this.lambda.length<j&&(this.lambda=new k(j+this.arrayStep),this.Bs=new k(j+this.arrayStep),this.invCs=new k(j+this.arrayStep));for(var p=this.invCs,s=this.Bs,t=this.lambda,u=0;u!==j;u++){var v=i[u];t[u]=0,s[u]=v.computeB(f,g,o),p[u]=1/v.computeC(h)}var w,v,x,y,z,A,B;if(0!==j){var u,C,D,E,F;for(u=0;u!==n;u++){var g=l[u],G=g.vlambda;q.set(G,0,0),g.wlambda=0}for(c=0;c!==d;c++){for(z=0,C=0;C!==j;C++)v=i[C],E=v.maxForce,D=v.minForce,w=s[C],x=p[C],B=t[C],A=v.computeGWlambda(h),y=x*(w-A-h*B),F=B+y,D>F?y=D-B:F>E&&(y=E-B),t[C]+=y,z+=m(y),v.addToWlambda(y);if(e>=z*z)break}for(u=0;u!==n;u++){var g=l[u],H=g.velocity;r(H,g.vlambda,H),g.angularVelocity+=g.wlambda}}return errorTot=z,c},a.Equation=function(a,b,c,d){this.id=-1,this.minForce="undefined"==typeof c?-1e6:c,this.maxForce="undefined"==typeof d?1e6:d,this.bi=a,this.bj=b},a.Equation.prototype.constructor=a.Equation,a.ContactEquation=function(b,c){a.Equation.call(this,b,c,0,1e6),this.penetration=0,this.ri=q.create(),this.penetrationVec=q.create(),this.rj=q.create(),this.ni=q.create(),this.rixn=q.create(),this.rjxn=q.create(),this.rixw=q.create(),this.rjxw=q.create(),this.relVel=q.create(),this.relForce=q.create()},a.ContactEquation.prototype=new a.Equation,a.ContactEquation.prototype.constructor=a.ContactEquation,a.ContactEquation.prototype.computeB=function(a,b,c){var d=this.bi,e=this.bj,f=this.ri,g=this.rj,h=d.position,i=e.position,j=d.velocity,k=d.angularVelocity,l=d.force,m=d.angularForce,n=e.velocity,o=e.angularVelocity,p=e.force,s=e.angularForce,w=(this.relVel,this.relForce,this.penetrationVec),x=d.invMass,y=e.invMass,z=d.invInertia,A=e.invInertia,B=this.ni,C=this.rixn=v(f,B),D=this.rjxn=v(g,B);q.set(w,0,0),r(i,g,w),t(w,h,w),t(w,f,w);var E=u(B,w),F=u(n,B)-u(j,B)+o*D-k*C,G=u(p,B)*y-u(l,B)*x+A*s*D-z*m*C,H=-E*a-F*b-c*G;return H},a.ContactEquation.prototype.computeC=function(a){var b=this.bi,c=this.bj,d=this.rixn,e=this.rjxn,f=b.invMass,g=c.invMass,h=f+g+a,i=b.invInertia,j=c.invInertia;return h+=i*d*d,h+=j*e*e};var M=q.create();a.ContactEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=M,d=0;return q.subtract(b.vlambda,a.vlambda,c),d+=q.dot(c,this.ni),d-=a.wlambda*this.rixn,d+=b.wlambda*this.rjxn};var N=q.create();a.ContactEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.rixn,e=this.rjxn,f=b.invMass,g=c.invMass,h=this.ni,i=N;s(h,f*a,i),t(b.vlambda,i,b.vlambda),s(h,g*a,i),r(c.vlambda,i,c.vlambda),b.wlambda-=b.invInertia*d*a,c.wlambda+=c.invInertia*e*a},"undefined"!=typeof module?module.exports=a:this.p2=a}.apply(this);