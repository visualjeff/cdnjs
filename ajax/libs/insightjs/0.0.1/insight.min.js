/*! insightjs 30-06-2014 */
var insight=function(){return{Charts:[],Groups:[],Dimensions:[],FilteredDimensions:[],DimensionChartMap:{},init:function(){this.Charts=[],this.Groups=[],this.FilteredDimensions=[],this.DimensionChartMap={}},redrawCharts:function(){for(var a=0;a<this.Charts.length;a++)this.Charts[a].draw()},addChart:function(a){return a.triggerRedraw=this.redrawCharts.bind(this),this.Charts.push(a),a},filterFunction:function(a){var b=a.key?a.key:a;return{name:b,filterFunction:function(a){return Array.isArray(a)?-1!=a.indexOf(b):String(a)==String(b)}}},compareFilters:function(a){return function(b){return String(b.name)==String(a.name)}},applyCSSClasses:function(a,b,c){var d=this.DimensionChartMap[a.data.dimension.Name];d.forEach(function(a){a.highlight(c,b)})},drawCharts:function(){var a=this;this.Charts.forEach(function(b){b.series().forEach(function(c){c.data.dimension&&(a.DimensionChartMap[c.data.dimension.Name]?-1==a.DimensionChartMap[c.data.dimension.Name].indexOf(b)&&a.DimensionChartMap[c.data.dimension.Name].push(b):a.DimensionChartMap[c.data.dimension.Name]=[b])}),b.init()});for(var b=0;b<this.Charts.length;b++)this.Charts[b].draw()},chartFilterHandler:function(a,b,c){var d=this;this.applyCSSClasses(a,b,c);var e=a.data.dimension,f=this.filterFunction(b);if(f){var g=this.Dimensions.filter(e.comparer),h=this.FilteredDimensions.filter(e.comparer);h.length||this.FilteredDimensions.push(e);var i=this.compareFilters(f);g.map(function(a){var b=a.Filters.filter(i).length;b?InsightUtils.removeMatchesFromArray(a.Filters,i):a.Filters.push(f),0===a.Filters.length?(InsightUtils.removeItemFromArray(d.FilteredDimensions,a),a.Dimension.filterAll()):a.Dimension.filter(function(b){var c=a.Filters.map(function(a){return a.filterFunction(b)});return c.filter(function(a){return a}).length>0})}),this.Groups.forEach(function(a){a.recalculate()}),this.redrawCharts()}}}}();insight.Constants=function(){var a={};return a.Behind="behind",a.Front="front",a.AxisTextClass="axis-text",a.AxisLabelClass="axis-label",a.YAxisClass="y-axis",a.AxisClass="in-axis",a.XAxisClass="x-axis",a.XAxisRotation="rotate(90)",a.ToolTipTextClass="tooltip",a.BarGroupClass="bargroup",a.ContainerClass="incontainer",a.ChartSVG="chartSVG",a.Bubble="bubble",a}(),insight.Scales=function(){var a={};return a.Ordinal={name:"ordinal",scale:d3.scale.ordinal},a.Linear={name:"linear",scale:d3.scale.linear},a.Time={name:"time",scale:d3.time.scale},a}();var InsightFormatters=function(a){var b={};return b.moduleProperty=1,b.currencyFormatter=function(b){var c=a.format("0,000");return"£"+c(b)},b.decimalCurrencyFormatter=function(b){var c=a.format("0.2f");return"£"+c(b)},b.numberFormatter=function(b){var c=a.format("0,000");return c(b)},b.dateFormatter=function(b){var c=a.time.format("%b %Y");return c(b)},b.percentageFormatter=function(b){var c=a.format("%");return c(b)},b}(d3),InsightUtils=function(){var a={};return a.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},a.isDate=function(a){return a instanceof Date},a.isNumber=function(a){return"[object Number]"===Object.prototype.toString.call(a)},a.removeMatchesFromArray=function(a,b){var c=this,d=a.filter(b);d.forEach(function(b){c.removeItemFromArray(a,b)})},a.removeItemFromArray=function(a,b){var c=a.indexOf(b);c>-1&&a.splice(c,1)},a}();insight.DataSet=function(a){function b(a){this._data=a,this.Dimensions=[],this.Groups=[],this.ndx=null,this._orderFunction=function(a,b){return b.value-a.value},this._filterFunction=null}return b.prototype.initialize=function(){},b.prototype.filterFunction=function(a){return arguments.length?(this._filterFunction=a,this):this._filterFunction},b.prototype.getData=function(){var a;return a=this._data.all?this._data.all():this._data,this._filterFunction&&(a=a.filter(this._filterFunction)),a},b.prototype.orderFunction=function(a){return arguments.length?(this._orderFunction=a,this):this._orderFunction},b.prototype.filterFunction=function(a){return arguments.length?(this._filterFunction=a,this):this._filterFunction},b.prototype.getOrderedData=function(){var a;return a=this._data.sort(this._orderFunction),this._filterFunction&&(a=a.filter(this._filterFunction)),a},b.prototype.group=function(b,c,d){this.ndx=this.ndx?this.ndx:crossfilter(this._data);var e=new a.Dimension(b,c,this.ndx.dimension(c),c,d),f=new a.Grouping(e);return a.Dimensions.push(e),a.Groups.push(f),f.preFilter=a.chartFilterHandler.bind(a),f},b}(insight),insight.Dimension=function(){var a=function(a,b,c,d,e){this.Dimension=c,this.Name=a,this.Filters=[],this.Function=b,this.multiple=e,this.displayFunction=d?d:function(a){return a},this.comparer=function(a){return a.Name==this.Name}.bind(this)};return a}(insight),insight.Grouping=function(){function a(a){this.dimension=a;var b=[],c=[],d=[],e=[],f=[];return this._compute=null,this.gIndices={},this._valueAccessor=function(a){return a},this._orderFunction=function(a,b){return b.value.Count-a.value.Count},this.registerSeries=function(a){f.push(a),a.clickEvent=this.preFilter},this.preFilter=function(){},this._ordered=!1,this.sum=function(a){return arguments.length?(b=a,this):b},this.cumulative=function(a){return arguments.length?(d=a,this):d},this.count=function(a){return arguments.length?(c=a,this):c},this.mean=function(a){return arguments.length?(e=a,b=this.unique(b.concat(e)),this):e},this}return a.prototype.ordered=function(a){return arguments.length?(this._ordered=a,this):this._ordered},a.prototype.filter=function(a){return arguments.length?(this._filterFunction=a,this):this._filterFunction},a.prototype.unique=function(a){for(var b=a.concat(),c=0;c<b.length;++c)for(var d=c+1;d<b.length;++d)b[c]===b[d]&&b.splice(d--,1);return b},a.prototype.reduceMultiDimension=function(){function a(a,b){for(var c in d){var g=d[c];if(b.hasOwnProperty(g))for(var h in b[g])if("undefined"!=typeof f[b[g][h]]){var i=f[b[g][h]];a.values[i].value++}else f[b[g][h]]=e,a.values[e]={key:b[g][h],value:1},e++}return a}function b(a,b){for(var c in d){var e=d[c];if(b.hasOwnProperty(e))for(var g in b[e]){var h=b[e][g],i=f[h];a.values[i].value--}}return a}function c(){return{values:[]}}var d=(this.sum(),this.count()),e=(this.mean(),0),f={};return data=this.dimension.Dimension.groupAll().reduce(a,b,c),this.orderFunction(function(a,b){return b.value-a.value}),data},a.prototype.initialize=function(){var a=this.sum(),b=this.count(),c=this.mean(),d=[];return d=this.dimension.multiple?this.reduceMultiDimension():this.dimension.Dimension.group().reduce(function(d,e){d.Count++;for(var f in a)e.hasOwnProperty(a[f])&&(d[a[f]].Sum+=e[a[f]]);for(var g in c)e.hasOwnProperty(c[g])&&(d[c[g]].Average=d[c[g]].Average+(e[c[g]]-d[c[g]].Average)/d.Count);for(var h in b)if(e.hasOwnProperty(b[h])){var i=b[h],j=e[b[h]];if(InsightUtils.isArray(j))for(var k in j){var l=j[k];d[i][l]=d[i].hasOwnProperty(l)?d[i][l]+1:1,d[i].Total++}else d[i][j]=d[i].hasOwnProperty(j)?d[i][j]+1:1,d[i].Total++}return d},function(d,e){d.Count--;for(var f in a)e.hasOwnProperty(a[f])&&(d[a[f]].Sum-=e[a[f]]);for(var g in b)if(e.hasOwnProperty(b[g])){var h=b[g],i=e[b[g]];if(InsightUtils.isArray(i))for(var j in i){var k=i[j];d[h][k]=d[h].hasOwnProperty(k)?d[h][k]-1:1,d[h].Total--}else d[h][i]=d[h].hasOwnProperty(i)?d[h][i]-1:1,d[h].Total--}for(var l in c)if(e.hasOwnProperty(c[l])){var m=(e[c[l]],d[c[l]].Sum);d[c[l]].Average=m/d.Count;var n=d[c[l]].Average;isFinite(n)||(d[c[l]].Average=0)}return d},function(){var d={Count:0};for(var e in a)d[a[e]]=d[a[e]]?d[a[e]]:{},d[a[e]].Sum=0;for(var f in c)d[c[f]]=d[c[f]]?d[c[f]]:{},d[c[f]].Average=0;for(var g in b)d[b[g]]=d[b[g]]?d[b[g]]:{},d[b[g]].Total=0;return d}),this._data=d,this.cumulative().length&&this.calculateTotals(),this},a.prototype.recalculate=function(){this.cumulative().length&&this.calculateTotals(),this._compute&&this._compute()},a.prototype.getData=function(){var a;return this._data||this.initialize(),a=this.dimension.multiple?this._data.value().values:this._data.all().slice(0),this._filterFunction&&(a=a.filter(this._filterFunction)),a},a.prototype.getOrderedData=function(a){var b=[];return this._data||this.initialize(),this.dimension.multiple?(b=this._data.value().values.slice(0),b=b.sort(this.orderFunction()),a&&(b=b.slice(0,a))):(b=this._data.all().slice(0).sort(this.orderFunction()),a&&(b=b.slice(0,a))),this._filterFunction&&(b=b.filter(this._filterFunction)),b},a.prototype.computeFunction=function(a){return this._ordered=!0,arguments.length?(this._compute=a.bind(this),this):this._compute},a.prototype.orderFunction=function(a){return arguments.length?(this._orderFunction=a,this):this._orderFunction},a.prototype.compute=function(){this._compute()},a.prototype.valueAccessor=function(a){return arguments.length?(this._valueAccessor=a,this):this._valueAccessor},a.prototype.getDescendant=function(a,b){for(var c=b.split("."),d=b,e=null;c.length;)d=c.shift(),e=a,a=a[d];return{container:e,value:a,propertyName:d}},a.prototype.calculateTotals=function(){var a=this,b=this.cumulative();if(b.length){var c={},d=this._ordered?this.getOrderedData():this.getData();d.forEach(function(d){b.map(function(b){var e=a.getDescendant(d.value,b),f=e.propertyName+"Cumulative";c[f]=c[f]?c[f]+e.value:e.value,e.container[f]=c[f]})})}return this},a}(insight),insight.Dashboard=function(a){var b=function(a){return this.Name=a,this.Charts=[],this.Dimensions=[],this.FilteredDimensions=[],this.Groups=[],this.ComputedGroups=[],this.DimensionChartMap={},this.DataSets=[],this.ndx=null,this};return b.prototype.addData=function(a){var b=crossfilter(a);return this.DataSets.push(b),b},b.prototype.addChart=function(a){var b=this;return a.triggerRedraw=this.redrawCharts.bind(this),this.Charts.push(a),a.series().forEach(function(c){c.data.dimension&&(b.DimensionChartMap[c.data.dimension.Name]?-1==b.DimensionChartMap[c.data.dimension.Name].indexOf(a)&&b.DimensionChartMap[c.data.dimension.Name].push(a):b.DimensionChartMap[c.data.dimension.Name]=[a])}),a},b.prototype.group=function(b,c,d,e){var f=new a.Dimension(c,d,b.dimension(d),d,e);this.Dimensions.push(f);var g=new a.Grouping(f);return g.preFilter=this.chartFilterHandler.bind(this),this.Groups.push(g),g},b.prototype.filterFunction=function(a){var b=a.key?a.key:a;return{name:b,filterFunction:function(a){return Array.isArray(a)?-1!=a.indexOf(b):String(a)==String(b)}}},b.prototype.compareFilters=function(a){return function(b){return String(b.name)==String(a.name)}},b.prototype.applyCSSClasses=function(a,b,c){var d=this.DimensionChartMap[a.data.dimension.Name];d.forEach(function(a){a.highlight(c,b)})},b.prototype.chartFilterHandler=function(a,b,c){var d=this;this.applyCSSClasses(a,b,c);var e=a.data.dimension,f=this.filterFunction(b);if(f){var g=this.Dimensions.filter(e.comparer),h=this.FilteredDimensions.filter(e.comparer);h.length||this.FilteredDimensions.push(e);var i=this.compareFilters(f);g.map(function(a){var b=a.Filters.filter(i).length;b?InsightUtils.removeMatchesFromArray(a.Filters,i):a.Filters.push(f),0===a.Filters.length?(InsightUtils.removeItemFromArray(d.FilteredDimensions,a),a.Dimension.filterAll()):a.Dimension.filter(function(b){var c=a.Filters.map(function(a){return a.filterFunction(b)});return c.filter(function(a){return a}).length>0})}),this.Groups.forEach(function(a){a.recalculate()}),this.ComputedGroups.forEach(function(a){a.compute()}),this.redrawCharts()}},b.prototype.initCharts=function(){this.Charts.forEach(function(a){a.init()})},b.prototype.redrawCharts=function(){for(var a=0;a<this.Charts.length;a++)this.Charts[a].draw()},b}(insight),insight.Series=function(a,b,c,d,e,f){this.chart=b,this.data=c,this.x=d,this.y=e,this.name=a,this.color=d3.functor(f),this.animationDuration=300,this.topValues=null,this.dimensionName=c.dimension?c.dimension.Name+"Dim":"",d.addSeries(this),e.addSeries(this),c.registerSeries&&c.registerSeries(this);var g=this,h="",i=null,j=function(a){return a.key},k=function(a){return a.value},l=function(a){return a.key},m=function(a){return a},n=function(a){return k(a)},o=function(a){return m(n(a))};return this.keyFunction=function(a){return arguments.length?(j=a,this):j},this.valueFunction=function(a){return arguments.length?(k=a,this):k},this.dataset=function(){var a=this.x.ordered()?this.data.getOrderedData(this.topValues):this.data.getData();return i&&(a=a.filter(i)),a},this.keys=function(){return this.dataset().map(g.xFunction())},this.cssClass=function(a){return arguments.length?(h=a,this):h},this.keyAccessor=function(a){return a.key},this.xFunction=function(a){return arguments.length?(l=a,this):l},this.mouseOver=function(a){g.chart.mouseOver(g,this,a)},this.mouseOut=function(a){g.chart.mouseOut(g,this,a)},this.sliceSelector=function(a){var b=a.key.toString(),c="in_"+b.replace(/[^A-Z0-9]/gi,"_");return c},this.selectedClassName=function(a){var b="";return g.chart.selectedItems.length&&(b=g.chart.selectedItems.indexOf(a)>-1?"selected":"notselected"),b},this.click=function(a,b){var c=g.sliceSelector(b);this.clickEvent(this,b,c)},this.filterFunction=function(a){return arguments.length?(i=a,this):i},this.tooltipFormat=function(a){return arguments.length?(m=a,this):m},this.tooltipFunction=function(a){return arguments.length?(o=a,this):o},this.top=function(a){return arguments.length?(this.topValues=a,this):this.topValues},this.maxLabelDimensions=function(a){var b=document.createElement("div");b.setAttribute("class",insight.Constants.AxisTextClass);var c=window.getComputedStyle(b),d=a.getContext("2d");d.font=c["font-size"]+" "+c["font-family"];var e=0;return this.keys().forEach(function(a){var b=d.measureText(a).width;e=b>e?b:e}),e},this.findMax=function(a){var b=this,c=0,d=this.data.getData(),e=a==b.x?b.keyFunction():b.valueFunction(),f=d3.max(d,e);return c=f>c?f:c},this.draw=function(){},this},insight.Series.prototype.clickEvent=function(){},function(a){a.Chart=function(a){function b(b,c,d){this.name=b,this.element=c,this.dimension=d,this.selectedItems=[];var e=d3.functor(300),f=d3.functor(300),g=!1,h=null;this.container=null,this.chart=null,this.measureCanvas=document.createElement("canvas"),this._margin={top:0,left:0,right:0,bottom:0};var i=[],j=[],k=[],l=this,m=d3.functor(.1),n="",o=!1;this.addAxis=function(a){k.push(a)},this.axes=function(){return k},this.addClipPath=function(){this.chart.append("clipPath").attr("id",this.clipPath()).append("rect").attr("x",1).attr("y",0).attr("width",this.width()-this.margin().left-this.margin().right).attr("height",this.height()-this.margin().top-this.margin().bottom)},this.init=function(b,c){o&&this.calculateLabelMargin(),this.container=b?d3.select(c).append("div"):d3.select(this.element).append("div"),this.container.attr("class",a.Constants.ContainerClass).style("width",this.width()+"px").style("position","relative").style("display","inline-block"),this.chartSVG=this.container.append("svg").attr("class",a.Constants.ChartSVG).attr("width",this.width()).attr("height",this.height()),this.chart=this.chartSVG.append("g").attr("class",a.Constants.Chart).attr("transform","translate("+this.margin().left+","+this.margin().top+")"),this.addClipPath(),j.map(function(a){a.initialize()}),k.map(function(a){a.initialize();a.scale.domain()}),g&&this.initZoom(),this.tooltip(),this.draw(!1)},this.resizeChart=function(){this.container.style("width",this.width()+"px"),this.chartSVG.attr("width",this.width()).attr("height",this.height()),this.chart=this.chart.attr("transform","translate("+this.margin().left+","+this.margin().top+")"),this.chart.select("#"+this.clipPath()).append("rect").attr("x",1).attr("y",0).attr("width",this.width()-this.margin().left-this.margin().right).attr("height",this.height()-this.margin().top-this.margin().bottom)},this.draw=function(a){this.resizeChart(),this.recalculateScales(),k.map(function(b){b.draw(a)}),this.series().map(function(b){b.draw(a)})},this.recalculateScales=function(){j.map(function(a){var b=h!=a;b&&a.initialize()})},this.zoomable=function(a){return g=!0,h=a,this},this.initZoom=function(){this.zoom=d3.behavior.zoom().on("zoom",l.dragging.bind(l)),this.zoom.x(h.scale),this.zoomExists()||this.chart.append("rect").attr("class","zoompane").attr("width",this.width()).attr("height",this.height()-this.margin().top-this.margin().bottom).style("fill","none").style("pointer-events","all"),this.chart.select(".zoompane").call(this.zoom)},this.zoomExists=function(){var a=this.chart.selectAll(".zoompane");return a[0].length},this.dragging=function(){l.draw(!0)},this.barPadding=function(a){return arguments.length?(m=d3.functor(a),this):m()},this.margin=function(a){return arguments.length?(this._margin=a,this):this._margin},this.clipPath=function(){return this.name.split(" ").join("_")+"clip"},this.tooltip=function(){return this.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return"<span class='tipvalue'>"+a+"</span>"}),this.chart.call(this.tip),this},this.mouseOver=function(a,b){var c=$(b).find(".tooltip").first().text();this.tip.show(c),d3.select(b).classed("active",!0)},this.mouseOut=function(a,b,c){this.tip.hide(c),d3.select(b).classed("active",!1)},this.title=function(a){return arguments.length?(n=a,this):n},this.width=function(a){return arguments.length?(f=d3.functor(a),this):f()},this.height=function(a){return arguments.length?(e=d3.functor(a),this):e()},this.series=function(a){return arguments.length?void(i=a):i},this.scales=function(a){return arguments.length?void(j=a):j},this.addHorizontalScale=function(a,b,c){new Scale(this,a,c,b)},this.addHorizontalAxis=function(a){new Axis(this,a,"h","left")},this.autoMargin=function(a){return arguments.length?(o=a,this):o},this.highlight=function(a){var b=this.chart.selectAll("."+a),c=b.classed("selected");c?(b.classed("selected",!1),InsightUtils.removeItemFromArray(l.selectedItems,a)):(b.classed("selected",!0).classed("notselected",!1),l.selectedItems.push(a));var d=this.chart.selectAll(".selected"),e=this.chart.selectAll(".bar:not(.selected),.bubble:not(.selected)");e.classed("notselected",d[0].length>0)},a.addChart(this)}return b.prototype.calculateLabelMargin=function(){var a=this.measureCanvas,b=0;this.series().forEach(function(c){var d=c.maxLabelDimensions(a);b=d>b?d:b}),this.margin().bottom=b},b.prototype.addColumnSeries=function(b){var c=new a.Scale(this,"","h",a.Scales.Ordinal),d=new a.Scale(this,"","v",a.Scales.Linear),e=b.stacked?!0:!1,f=new a.ColumnSeries(b.name,this,b.data,c,d,b.color).stacked(e);return f.series=[b],this.series().push(f),f},b.prototype.addLineSeries=function(b){var c=new a.Scale(this,"","h",a.Scales.Ordinal),d=new a.Scale(this,"","v",a.Scales.Linear),e=new a.LineSeries(b.name,this,b.data,c,d,b.color).valueFunction(b.accessor);return this.series().push(e),e},b.prototype.addBulletChart=function(b){var c=new a.Scale(this,b.name+"x","h",a.Scales.Linear),d=new a.Scale(this,b.name+"y","v",a.Scales.Ordinal),e=new a.RowSeries(b.name,this,b.ranges[0].data,c,d,"blue").stacked(!0);e.mouseOver=function(){},e.series=b.ranges,this.series().push(e);var f=new a.RowSeries(b.value.name,this,b.value.data,c,d,b.value.color);f.barThickness=function(a){return this.y.scale.rangeBand(a)*(1/3)}.bind(f),f.yPosition=function(a){return this.y.scale(this.keyFunction()(a))+this.y.scale.rangeBand(a)/3}.bind(f),f.series=[b.value],this.series().push(f);var g=new a.MarkerSeries(b.target.name,this,b.target.data,c,d,b.target.color).valueFunction(b.target.accessor).widthFactor(.3).horizontal();return this.series().push(g),e},b}(a)}(insight),insight.MarkerSeries=function(a,b,c,d,e,f){insight.Series.call(this,a,b,c,d,e,f);var g=this,h=5,i=1,j=0,k=!1,l=!0;return this.xPosition=function(a){var b=0;return l?(b=g.x.scale(g.keyFunction()(a)),j||(j=g.calculateOffset(a)),b=1!=i?b+j:b):b=g.x.scale(g.valueFunction()(a)),b},this.keys=function(){var a=g.keyFunction();return g.dataset().map(a)},this.calculateOffset=function(a){var b=k?g.markerHeight(a):g.markerWidth(a),c=k?g.y.scale.rangeBand(a):g.x.scale.rangeBand(a);return.5*(c-b)},this.yPosition=function(a){var b=0;return k?(b=g.y.scale(g.keyFunction()(a)),j||(j=g.calculateOffset(a)),b=1!=i?b+j:b):b=g.y.scale(g.valueFunction()(a)),b},this.horizontal=function(){return k=!0,l=!1,this},this.vertical=function(){return l=!0,k=!1,this},this.widthFactor=function(a){return arguments.length?(i=a,this):i},this.thickness=function(a){return arguments.length?(h=a,this):h},this.markerWidth=function(a){var b=0;return b=k?g.thickness():g.x.scale.rangeBand(a)*i},this.markerHeight=function(a){var b=0;return b=k?g.y.scale.rangeBand(a)*i:g.thickness()},this.className=function(a){var b=g.sliceSelector(a),c=g.selectedClassName(b);return g.name+"class bar "+b+" "+c+" "+g.dimensionName},this.draw=function(){var a=function(a){a.yPos=0,a.xPos=0},b=(this.dataset().forEach(a),this.chart.chart.selectAll("g."+insight.Constants.BarGroupClass+"."+this.name).data(this.dataset(),this.keyAccessor)),c=b.enter().append("g").attr("class",insight.Constants.BarGroupClass+" "+this.name),d=c.selectAll("rect.bar"),e=function(a){return g.click(this,a)},f=function(a,b){return 200+20*b};d=c.append("rect").attr("class",g.className).attr("y",this.y.bounds[0]).attr("height",0).attr("fill",this.color).attr("clip-path","url(#"+this.chart.clipPath()+")").on("mouseover",this.mouseOver).on("mouseout",this.mouseOut).on("click",e),d.append("svg:text").attr("class",insight.Constants.ToolTipTextClass);var h=b.selectAll("."+this.name+"class.bar");h.transition().duration(f).attr("y",this.yPosition).attr("x",this.xPosition).attr("width",this.markerWidth).attr("height",this.markerHeight),h.selectAll("."+insight.Constants.ToolTipTextClass).text(this.tooltipFunction()),b.exit().remove()},this},insight.MarkerSeries.prototype=Object.create(insight.Series.prototype),insight.MarkerSeries.prototype.constructor=insight.MarkerSeries,insight.BubbleSeries=function(a,b,c,d,e,f){insight.Series.call(this,a,b,c,d,e,f);var g=d3.functor(10),h=d3.functor(f),i=d3.functor(50),j=d3.functor(7),k=!1,l=this,m=function(){},n=function(){},o=function(a){l.chart.mouseOver(l,this,a),d3.select(this).classed("hover",!0)},p=function(a){l.chart.mouseOut(l,this,a)};this.findMax=function(a){var b=this,c=0,d=this.data.getData(),e=a==b.x?b.xFunction():b.yFunction(),f=d3.max(d,e);return c=f>c?f:c},this.yFunction=function(a){return arguments.length?(n=a,this):n},this.xFunction=function(a){return arguments.length?(m=a,this):m},this.rangeY=function(a){l.yFunction();return l.y.scale(l.yFunction()(a))},this.rangeX=function(a){l.xFunction();return l.x.scale(l.xFunction()(a))},this.radiusFunction=function(a){return arguments.length?(g=a,this):g},this.fillFunction=function(a){return arguments.length?(h=a,this):h},this.selector=this.name+insight.Constants.Bubble,this.className=function(a){return l.selector+" "+insight.Constants.Bubble+" "+l.sliceSelector(a)+" "+l.dimensionName},this.draw=function(a){var b=a?0:function(a,b){return 200+20*b},c=this.dataset(),d=d3.min(c,g),e=d3.max(c,g),f=function(a){return a.radius},m=function(a){return l.click(this,a)};c.forEach(function(a){var b=g(a);a.radius=j()+(b-d)*(i()-j())/(e-d)}),c=c.concat().sort(function(a,b){return d3.descending(f(a),f(b))});var n=this.chart.chart.selectAll("circle."+l.selector).data(c,l.keyAccessor);n.enter().append("circle").attr("class",l.className).on("mouseover",o).on("mouseout",p).on("click",m),n.transition().duration(b).attr("r",f).attr("cx",l.rangeX).attr("cy",l.rangeY).attr("fill",h),k||(n.append("svg:text").attr("class",insight.Constants.ToolTipTextClass),k=!0),n.selectAll("."+insight.Constants.ToolTipTextClass).text(this.tooltipFunction())}},insight.BubbleSeries.prototype=Object.create(insight.Series.prototype),insight.BubbleSeries.prototype.constructor=insight.BubbleSeries,insight.RowSeries=function(a,b,c,d,e,f){insight.Series.call(this,a,b,c,d,e,f);var g=this,h=d3.functor(!1),i="",j=function(a){var b=g.series[g.currentSeries].accessor;return g.tooltipFormat()(b(a))};return this.series=[{name:"default",accessor:function(a){return g.valueFunction()(a)},tooltipValue:function(a){return g.tooltipFunction()(a)},color:d3.functor("silver"),label:"Value"}],this.keys=function(){return g.dataset().map(g.keyFunction())},this.seriesMax=function(a){var b=0,c=0,d=g.stacked();for(var e in g.series){var f=g.series[e],h=f.accessor(a);c=d?c+h:h,b=c>b?c:b}return b},this.findMax=function(){var a=d3.max(this.data.getData(),this.seriesMax);return a},this.stacked=function(a){return arguments.length?(h=d3.functor(a),this):h()},this.calculateXPos=function(a,b){b.xPos||(b.xPos=0);var c=b.xPos;return b.xPos+=a(b),c},this.yPosition=function(a){return g.y.scale(g.keyFunction()(a))},this.calculateYPos=function(a,b){return b.yPos?b.yPos+=a:b.yPos=g.yPosition(b),b.yPos},this.xPosition=function(a){var b=g.series[g.currentSeries].accessor,c=g.stackedBars()?g.x.scale(g.calculateXPos(b,a)):0;return c},this.barThickness=function(a){return g.y.scale.rangeBand(a)},this.groupedbarThickness=function(a){var b=g.barThickness(a),c=g.stackedBars()||1==g.series.length?b:b/g.series.length;return c},this.offsetYPosition=function(a){var b=g.groupedbarThickness(a),c=g.stackedBars()?g.yPosition(a):g.calculateYPos(b,a);return c},this.barWidth=function(a){var b=g.series[g.currentSeries].accessor;return g.x.scale(b(a))},this.stackedBars=function(){return g.stacked()},this.className=function(a){return i+"class bar "+g.sliceSelector(a)},this.draw=function(){var a=function(a){a.yPos=0,a.xPos=0},b=this.chart.chart.selectAll("g."+insight.Constants.BarGroupClass+"."+this.name).data(this.dataset(),this.keyAccessor).each(a),c=b.enter().append("g").attr("class",insight.Constants.BarGroupClass+" "+this.name),d=c.selectAll("rect.bar"),e=function(a){return g.click(this,a)},f=function(a,b){return 200+20*b};for(var h in this.series){this.currentSeries=h;var k=this.series[h];i=k.name,d=c.append("rect").attr("class",g.className).attr("height",0).attr("fill",k.color).attr("clip-path","url(#"+this.chart.clipPath()+")").on("mouseover",this.mouseOver).on("mouseout",this.mouseOut).on("click",e),d.append("svg:text").attr("class",insight.Constants.ToolTipTextClass);var l=b.selectAll("."+i+"class.bar").transition().duration(f).attr("y",this.offsetYPosition).attr("x",this.xPosition).attr("height",this.groupedbarThickness).attr("width",this.barWidth);l.selectAll("."+insight.Constants.ToolTipTextClass).text(j)}},this},insight.RowSeries.prototype=Object.create(insight.Series.prototype),insight.RowSeries.prototype.constructor=insight.RowSeries,insight.Scale=function(a,b,c,d){var e=d3.functor(!1),f=this;this.scale=d.scale(),this.rangeType=this.scale.rangeRoundBands?this.scale.rangeRoundBands:this.scale.rangeRound,this.series=[],this.title=b,this.chart=a,this.type=d,this.direction=c,this.bounds=[],a.scales().push(this),this.domain=function(){return d.name==insight.Scales.Linear.name?[0,this.findMax()]:d.name==insight.Scales.Ordinal.name?this.findOrdinalValues():d.name==insight.Scales.Time.name?[this.minTime(),this.maxTime()]:void 0},this.calculateBounds=function(){var a=[];return f.horizontal()?(a[0]=0,a[1]=f.chart.width()-f.chart.margin().right-f.chart.margin().left):f.vertical()&&(a[0]=f.chart.height()-f.chart.margin().top-f.chart.margin().bottom,a[1]=0),a},this.minTime=function(){var a=new Date(864e13);return this.series.map(function(b){var c=d3.min(b.keys());a=a>c?c:a}),a},this.maxTime=function(){var a=new Date(-864e13);return this.series.map(function(b){var c=d3.max(b.keys());a=c>a?c:a}),a},this.findOrdinalValues=function(){var a=[];return this.series.map(function(b){a=b.keys()}),a},this.horizontal=function(){return"h"==this.direction},this.vertical=function(){return"v"==this.direction},this.findMax=function(){var a=0;return this.series.map(function(b){var c=b.findMax(f);a=c>a?c:a}),a},this.addSeries=function(a){this.series.push(a)},this.initialize=function(){this.applyScaleRange.call(this.scale.domain(this.domain()),this.rangeType)},this.calculateRange=function(){this.scale.domain(this.domain())},this.applyScaleRange=function(a){var b=f.calculateBounds();f.bounds=b,a.apply(this,[b,f.chart.barPadding()])},this.ordered=function(a){return arguments.length?(e=d3.functor(a),this):e()}},insight.Axis=function(a,b,c,d){this.chart=a,this.scale=c,this.anchor=d?d:"left",this.name=b;var e,f=c.title,g=this,h=d3.functor(0),i=d3.functor(10),j="90",k=d3.functor("lr"),l=d3.functor(c.horizontal()?this.anchor:this.anchor),m=!1,n=[];c.vertical()&&(e="left"==this.anchor?"end":"start"),c.horizontal()&&(e="start");var o=function(a){return a};this.chart.addAxis(this),this.label=function(a){return arguments.length?(f=a,this):f},this.labelFormat=function(a){return arguments.length?(o=a,this):o},this.orientation=function(a){return arguments.length?(l=d3.functor(a),this):l()},this.labelRotation=function(a){return arguments.length?(j=a,this):j},this.tickSize=function(a){return arguments.length?(h=d3.functor(a),this):h()},this.tickPadding=function(a){return arguments.length?(i=d3.functor(a),this):i()},this.textAnchor=function(a){return arguments.length?(e=a,this):e},this.labelOrientation=function(a){return arguments.length?(k=d3.functor(a),this):k()},this.tickRotation=function(){var a=g.tickPadding()+2*g.tickSize();a="top"==g.anchor?0-a:a;var b="tb"==this.labelOrientation()?" rotate("+g.labelRotation()+",0,"+a+")":"";return b},this.transform=function(){var a="translate(";if(g.scale.horizontal()){var b=0,c="top"==g.anchor?0:g.chart.height()-g.chart.margin().bottom-g.chart.margin().top;a+=b+","+c+")"}else if(g.scale.vertical()){var d="left"==g.anchor?0:g.chart.width()-g.chart.margin().right-g.chart.margin().left;a+=d+",0)"}return a},this.labelHorizontalPosition=function(){var a="";return g.scale.horizontal()||g.scale.vertical(),a},this.labelVerticalPosition=function(){var a="";return g.scale.horizontal()||g.scale.vertical(),a},this.positionLabels=function(a){g.scale.horizontal()?a.style("left",0).style(g.anchor,0).style("width","100%").style("text-align","center"):g.scale.vertical()&&a.style(g.anchor,"0").style("top","35%")},this.gridlines=function(a){return arguments.length?(m=!0,n=a,this):n()},this.drawGridLines=function(){var b=this.scale.scale.ticks(5);this.chart.chart.selectAll("line.horizontalGrid").data(b).enter().append("line").attr({"class":"horizontalGrid",x1:0,x2:a.width(),y1:function(a){return g.scale(a)},y2:function(a){return g.scale(a)},fill:"none","shape-rendering":"crispEdges",stroke:"silver","stroke-width":"1px"})},this.initialize=function(){this.axis=d3.svg.axis().scale(this.scale.scale).orient(g.orientation()).tickSize(g.tickSize()).tickPadding(g.tickPadding()).tickFormat(g.labelFormat()),this.chart.chart.append("g").attr("class",g.name+" "+insight.Constants.AxisClass).attr("transform",g.transform()).call(this.axis).selectAll("text").attr("class",g.name+" "+insight.Constants.AxisTextClass).style("text-anchor",g.textAnchor()).style("transform",g.tickRotation());var a=this.chart.container.append("div").attr("class",g.name+insight.Constants.AxisLabelClass).style("position","absolute").text(this.label());this.positionLabels(a)},this.draw=function(){this.axis=d3.svg.axis().scale(this.scale.scale).orient(g.orientation()).tickSize(g.tickSize()).tickPadding(g.tickPadding()).tickFormat(g.labelFormat());var a=this.chart.chart.selectAll("g."+g.name+"."+insight.Constants.AxisClass).transition().duration(500).attr("transform",g.transform()).call(this.axis);a.selectAll("text").attr("transform",g.tickRotation()).style("text-anchor",g.textAnchor()),d3.select(this.chart.element).select("div."+g.name+insight.Constants.AxisLabelClass).text(this.label())}},insight.LineSeries=function(a,b,c,d,e,f){insight.Series.call(this,a,b,c,d,e,f);var g=this,h="linear",i=!1,j=function(a){g.chart.mouseOver(g,this,a),d3.select(this).classed("hover",!0)},k=function(a){g.chart.mouseOut(g,this,a)},l=function(){},m=function(){},n=function(){};this.rangeY=function(a){return g.y.scale(g.valueFunction()(a))},this.rangeX=function(a){var b=0;return b=g.x.scale.rangeBand?g.x.scale(g.keyFunction()(a))+g.x.scale.rangeBand()/2:g.x.scale(g.keyFunction()(a))},this.lineType=function(a){return arguments.length?(h=a,this):h},this.draw=function(a){var b=d3.svg.line().x(g.rangeX).y(g.rangeY).interpolate(h),c=(this.dataset(),"path."+this.name+".in-line"),d=this.chart.chart.selectAll(c);
this.rangeExists(d)||this.chart.chart.append("path").attr("class",this.name+" in-line").attr("stroke",this.color).attr("fill","none").attr("clip-path","url(#"+this.chart.clipPath()+")").on("mouseover",l).on("mouseout",m).on("click",n);var e=a?0:function(a,b){return 300+20*b};this.chart.chart.selectAll(c).datum(this.dataset(),this.matcher).transition().duration(e).attr("d",b);var f=this.chart.chart.selectAll("circle").data(this.dataset());f.enter().append("circle").attr("class","target-point").attr("clip-path","url(#"+this.chart.clipPath()+")").attr("cx",g.rangeX).attr("cy",g.chart.height()-g.chart.margin().bottom-g.chart.margin().top).on("mouseover",j).on("mouseout",k),f.transition().duration(e).attr("cx",g.rangeX).attr("cy",g.rangeY).attr("r",2.5),i||(f.append("svg:text").attr("class",insight.Constants.ToolTipTextClass),i=!0),f.selectAll("."+insight.Constants.ToolTipTextClass).text(this.tooltipFunction())},this.rangeExists=function(a){return a[0].length}},insight.LineSeries.prototype=Object.create(insight.Series.prototype),insight.LineSeries.prototype.constructor=insight.LineSeries,insight.ColumnSeries=function(a,b,c,d,e,f){insight.Series.call(this,a,b,c,d,e,f);var g=this,h=d3.functor(!1),i="",j=(this.x.rangeType,function(a){var b=g.series[g.currentSeries].accessor;return g.tooltipFormat()(b(a))});return this.series=[{name:"default",accessor:function(a){return g.valueFunction()(a)},tooltipValue:function(a){return g.tooltipFunction()(a)},color:d3.functor("silver"),label:"Value"}],this.seriesMax=function(a){var b=0,c=0,d=g.stacked();for(var e in g.series){var f=g.series[e],h=f.accessor(a);c=d?c+h:h,b=c>b?c:b}return b},this.findMax=function(){var a=d3.max(this.data.getData(),this.seriesMax);return a},this.stacked=function(a){return arguments.length?(h=d3.functor(a),this):h()},this.calculateYPos=function(a,b){return b.yPos||(b.yPos=0),b.yPos+=a(b),b.yPos},this.xPosition=function(a){return g.x.scale(g.keyFunction()(a))},this.calculateXPos=function(a,b){return b.xPos?b.xPos+=a:b.xPos=g.xPosition(b),b.xPos},this.yPosition=function(a){var b=g.series[g.currentSeries].accessor,c=g.y.scale(g.stackedBars()?g.calculateYPos(b,a):b(a));return c},this.barWidth=function(a){return g.x.scale.rangeBand(a)},this.groupedBarWidth=function(a){var b=g.barWidth(a),c=g.stackedBars()||1==g.series.length?b:b/g.series.length;return c},this.offsetXPosition=function(a){var b=g.groupedBarWidth(a),c=g.stackedBars()?g.xPosition(a):g.calculateXPos(b,a);return c},this.barHeight=function(a){var b=g.series[g.currentSeries].accessor;return g.chart.height()-g.chart.margin().top-g.chart.margin().bottom-g.y.scale(b(a))},this.stackedBars=function(){return g.stacked()},this.className=function(a){var b=g.sliceSelector(a),c=g.selectedClassName(b);return i+"class bar "+b+" "+c+" "+g.dimensionName},this.draw=function(){var a=function(a){a.yPos=0,a.xPos=0},b=(this.dataset().forEach(a),this.chart.chart.selectAll("g."+insight.Constants.BarGroupClass).data(this.dataset(),this.keyAccessor)),c=b.enter().append("g").attr("class",insight.Constants.BarGroupClass),d=c.selectAll("rect.bar"),e=function(a){return g.click(this,a)},f=function(a,b){return 200+20*b};for(var h in this.series){this.currentSeries=h;var k=this.series[h];i=k.name,d=c.append("rect").attr("class",g.className).attr("y",this.y.bounds[0]).attr("height",0).attr("fill",k.color).attr("clip-path","url(#"+this.chart.clipPath()+")").on("mouseover",this.mouseOver).on("mouseout",this.mouseOut).on("click",e),d.append("svg:text").attr("class",insight.Constants.ToolTipTextClass);var l=b.selectAll("."+i+"class.bar");l.transition().duration(f).attr("y",this.yPosition).attr("x",this.offsetXPosition).attr("width",this.groupedBarWidth).attr("height",this.barHeight),l.selectAll("."+insight.Constants.ToolTipTextClass).text(j)}b.exit().remove()},this},insight.ColumnSeries.prototype=Object.create(insight.Series.prototype),insight.ColumnSeries.prototype.constructor=insight.ColumnSeries;