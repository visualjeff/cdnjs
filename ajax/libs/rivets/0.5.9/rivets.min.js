// Rivets.js
// version: 0.5.9
// author: Michael Richards
// license: MIT
(function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},i=[].slice,n=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};t={},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),t.Binding=function(){function n(i,n,s,r,h,o){var u,l,a,d;if(this.view=i,this.el=n,this.type=s,this.key=r,this.keypath=h,this.options=null!=o?o:{},this.update=e(this.update,this),this.unbind=e(this.unbind,this),this.bind=e(this.bind,this),this.publish=e(this.publish,this),this.sync=e(this.sync,this),this.set=e(this.set,this),this.eventHandler=e(this.eventHandler,this),this.formattedValue=e(this.formattedValue,this),!(this.binder=t.internalBinders[this.type]||this.view.binders[s])){d=this.view.binders;for(u in d)a=d[u],"*"!==u&&-1!==u.indexOf("*")&&(l=RegExp("^"+u.replace("*",".+")+"$"),l.test(s)&&(this.binder=a,this.args=RegExp("^"+u.replace("*","(.+)")+"$").exec(s),this.args.shift()))}this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function&&(this.binder={routine:this.binder}),this.formatters=this.options.formatters||[],this.model=this.key?this.view.models[this.key]:this.view.models}return n.prototype.formattedValue=function(t){var e,n,s,r,h,o;for(o=this.formatters,r=0,h=o.length;h>r;r++)n=o[r],e=n.split(/\s+/),s=e.shift(),n=this.model[s]instanceof Function?this.model[s]:this.view.formatters[s],(null!=n?n.read:void 0)instanceof Function?t=n.read.apply(n,[t].concat(i.call(e))):n instanceof Function&&(t=n.apply(null,[t].concat(i.call(e))));return t},n.prototype.eventHandler=function(t){var e,i;return i=(e=this).view.config.handler,function(n){return i.call(t,this,n,e)}},n.prototype.set=function(t){var e;return t=t instanceof Function&&!this.binder["function"]?this.formattedValue(t.call(this.model)):this.formattedValue(t),null!=(e=this.binder.routine)?e.call(this,this.el,t):void 0},n.prototype.sync=function(){return this.set(this.options.bypass?this.model[this.keypath]:this.view.config.adapter.read(this.model,this.keypath))},n.prototype.publish=function(){var e,n,s,r,h,o,u,l,a;for(r=t.Util.getInputValue(this.el),u=this.formatters.slice(0).reverse(),h=0,o=u.length;o>h;h++)n=u[h],e=n.split(/\s+/),s=e.shift(),(null!=(l=this.view.formatters[s])?l.publish:void 0)&&(r=(a=this.view.formatters[s]).publish.apply(a,[r].concat(i.call(e))));return this.view.config.adapter.publish(this.model,this.keypath,r)},n.prototype.bind=function(){var t,e,i,n,s,r,h,o,u;if(null!=(r=this.binder.bind)&&r.call(this,this.el),this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync()),null!=(h=this.options.dependencies)?h.length:void 0){for(o=this.options.dependencies,u=[],n=0,s=o.length;s>n;n++)t=o[n],/^\./.test(t)?(i=this.model,e=t.substr(1)):(t=t.split("."),i=this.view.models[t.shift()],e=t.join(".")),u.push(this.view.config.adapter.subscribe(i,e,this.sync));return u}},n.prototype.unbind=function(){var t,e,i,n,s,r,h,o,u;if(null!=(r=this.binder.unbind)&&r.call(this,this.el),this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),null!=(h=this.options.dependencies)?h.length:void 0){for(o=this.options.dependencies,u=[],n=0,s=o.length;s>n;n++)t=o[n],/^\./.test(t)?(i=this.model,e=t.substr(1)):(t=t.split("."),i=this.view.models[t.shift()],e=t.join(".")),u.push(this.view.config.adapter.unsubscribe(i,e,this.sync));return u}},n.prototype.update=function(t){var e;return null==t&&(t={}),this.key?t[this.key]&&(this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),this.model=t[this.key],this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync())):this.sync(),null!=(e=this.binder.update)?e.call(this,t):void 0},n}(),t.View=function(){function s(i,n,s){var r,h,o,u,l,a,d,c,p,f;for(this.els=i,this.models=n,this.options=null!=s?s:{},this.update=e(this.update,this),this.publish=e(this.publish,this),this.sync=e(this.sync,this),this.unbind=e(this.unbind,this),this.bind=e(this.bind,this),this.select=e(this.select,this),this.build=e(this.build,this),this.bindingRegExp=e(this.bindingRegExp,this),this.els.jquery||this.els instanceof Array||(this.els=[this.els]),d=["config","binders","formatters"],l=0,a=d.length;a>l;l++){if(h=d[l],this[h]={},this.options[h]){c=this.options[h];for(r in c)o=c[r],this[h][r]=o}p=t[h];for(r in p)o=p[r],null==(f=(u=this[h])[r])&&(u[r]=o)}this.build()}return s.prototype.bindingRegExp=function(){var t;return t=this.config.prefix,t?RegExp("^data-"+t+"-"):/^data-/},s.prototype.build=function(){var e,s,r,h,o,u,l,a,d=this;for(this.bindings=[],o=[],e=this.bindingRegExp(),s=function(e,i,n){var s,r,h,o,u,l,a,c,p,f;return l={},p=function(){var t,e,i,s;for(i=n.split("|"),s=[],t=0,e=i.length;e>t;t++)c=i[t],s.push(c.trim());return s}(),s=function(){var t,e,i,n;for(i=p.shift().split("<"),n=[],t=0,e=i.length;e>t;t++)r=i[t],n.push(r.trim());return n}(),a=s.shift(),f=a.split(/\.|:/),l.formatters=p,l.bypass=-1!==a.indexOf(":"),f[0]?o=f.shift():(o=null,f.shift()),u=f.join("."),(h=s.shift())&&(l.dependencies=h.split(/\s+/)),d.bindings.push(new t.Binding(d,e,i,o,u,l))},h=function(r){var u,l,a,c,p,f,b,v,g,y,m,w,x,k,E,N,j,T,U,V,B,C,O,Q,R,A,D,F,H,L,S,$;if(0>n.call(o,r)){if(r.nodeType===Node.TEXT_NODE){if(v=t.TextTemplateParser,(p=d.config.templateDelimiters)&&(k=v.parse(r.data,p)).length&&(1!==k.length||k[0].type!==v.types.text)){switch(m=k[0],y=k.length>=2?i.call(k,1):[],r.data=m.value,m.type){case 0:r.data=m.value;break;case 1:s(r,"textNode",m.value)}for(j=0,B=y.length;B>j;j++)x=y[j],r.parentNode.appendChild(w=document.createTextNode(x.value)),1===x.type&&s(w,"textNode",x.value)}}else if(null!=r.attributes){for(D=r.attributes,T=0,C=D.length;C>T;T++)if(u=D[T],e.test(u.name)){if(E=u.name.replace(e,""),!(a=d.binders[E])){F=d.binders;for(f in F)N=F[f],"*"!==f&&-1!==f.indexOf("*")&&(g=RegExp("^"+f.replace("*",".+")+"$"),g.test(E)&&(a=N))}if(a||(a=d.binders["*"]),a.block){for(H=r.childNodes,U=0,O=H.length;O>U;U++)b=H[U],o.push(b);l=[u]}}for(L=l||r.attributes,V=0,Q=L.length;Q>V;V++)u=L[V],e.test(u.name)&&(E=u.name.replace(e,""),s(r,E,u.value))}for(S=r.childNodes,$=[],A=0,R=S.length;R>A;A++)c=S[A],$.push(h(c));return $}},a=this.els,u=0,l=a.length;l>u;u++)r=a[u],h(r)},s.prototype.select=function(t){var e,i,n,s,r;for(s=this.bindings,r=[],i=0,n=s.length;n>i;i++)e=s[i],t(e)&&r.push(e);return r},s.prototype.bind=function(){var t,e,i,n,s;for(n=this.bindings,s=[],e=0,i=n.length;i>e;e++)t=n[e],s.push(t.bind());return s},s.prototype.unbind=function(){var t,e,i,n,s;for(n=this.bindings,s=[],e=0,i=n.length;i>e;e++)t=n[e],s.push(t.unbind());return s},s.prototype.sync=function(){var t,e,i,n,s;for(n=this.bindings,s=[],e=0,i=n.length;i>e;e++)t=n[e],s.push(t.sync());return s},s.prototype.publish=function(){var t,e,i,n,s;for(n=this.select(function(t){return t.binder.publishes}),s=[],e=0,i=n.length;i>e;e++)t=n[e],s.push(t.publish());return s},s.prototype.update=function(t){var e,i,n,s,r,h,o;null==t&&(t={});for(i in t)n=t[i],this.models[i]=n;for(h=this.bindings,o=[],s=0,r=h.length;r>s;s++)e=h[s],o.push(e.update(t));return o},s}(),t.TextTemplateParser=function(){function t(){}return t.types={text:0,binding:1},t.parse=function(t,e){var i,n,s,r,h,o,u;for(o=[],r=t.length,i=0,n=0;r>n;){if(i=t.indexOf(e[0],n),0>i){o.push({type:this.types.text,value:t.slice(n)});break}if(i>0&&i>n&&o.push({type:this.types.text,value:t.slice(n,i)}),n=i+2,i=t.indexOf(e[1],n),0>i){h=t.slice(n-2),s=o[o.length-1],(null!=s?s.type:void 0)===this.types.text?s.value+=h:o.push({type:this.types.text,value:h});break}u=t.slice(n,i).trim(),o.push({type:this.types.binding,value:u}),n=i+2}return o},t}(),t.Util={bindEvent:function(t,e,i){return null!=window.jQuery?(t=jQuery(t),null!=t.on?t.on(e,i):t.bind(e,i)):null!=window.addEventListener?t.addEventListener(e,i,!1):(e="on"+e,t.attachEvent(e,i))},unbindEvent:function(t,e,i){return null!=window.jQuery?(t=jQuery(t),null!=t.off?t.off(e,i):t.unbind(e,i)):null!=window.removeEventListener?t.removeEventListener(e,i,!1):(e="on"+e,t.detachEvent(e,i))},getInputValue:function(t){var e,i,n,s;if(null!=window.jQuery)switch(t=jQuery(t),t[0].type){case"checkbox":return t.is(":checked");default:return t.val()}else switch(t.type){case"checkbox":return t.checked;case"select-multiple":for(s=[],i=0,n=t.length;n>i;i++)e=t[i],e.selected&&s.push(e.value);return s;default:return t.value}}},t.binders={enabled:function(t,e){return t.disabled=!e},disabled:function(t,e){return t.disabled=!!e},checked:{publishes:!0,bind:function(e){return t.Util.bindEvent(e,"change",this.publish)},unbind:function(e){return t.Util.unbindEvent(e,"change",this.publish)},routine:function(t,e){var i;return t.checked="radio"===t.type?(null!=(i=t.value)?""+i:void 0)===(null!=e?""+e:void 0):!!e}},unchecked:{publishes:!0,bind:function(e){return t.Util.bindEvent(e,"change",this.publish)},unbind:function(e){return t.Util.unbindEvent(e,"change",this.publish)},routine:function(t,e){var i;return t.checked="radio"===t.type?(null!=(i=t.value)?""+i:void 0)!==(null!=e?""+e:void 0):!e}},show:function(t,e){return t.style.display=e?"":"none"},hide:function(t,e){return t.style.display=e?"none":""},html:function(t,e){return t.innerHTML=null!=e?e:""},value:{publishes:!0,bind:function(e){return t.Util.bindEvent(e,"change",this.publish)},unbind:function(e){return t.Util.unbindEvent(e,"change",this.publish)},routine:function(t,e){var i,s,r,h,o,u,l;if(null!=window.jQuery){if(t=jQuery(t),(null!=e?""+e:void 0)!==(null!=(h=t.val())?""+h:void 0))return t.val(null!=e?e:"")}else if("select-multiple"===t.type){if(null!=e){for(l=[],s=0,r=t.length;r>s;s++)i=t[s],l.push(i.selected=(o=i.value,n.call(e,o)>=0));return l}}else if((null!=e?""+e:void 0)!==(null!=(u=t.value)?""+u:void 0))return t.value=null!=e?e:""}},text:function(t,e){return null!=t.innerText?t.innerText=null!=e?e:"":t.textContent=null!=e?e:""},"if":{block:!0,bind:function(t){var e,i;return null==this.marker?(e=["data",this.view.config.prefix,this.type].join("-").replace("--","-"),i=t.getAttribute(e),this.marker=document.createComment(" rivets: "+this.type+" "+i+" "),t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)):void 0},unbind:function(){var t;return null!=(t=this.nested)?t.unbind():void 0},routine:function(e,i){var n,s,r,h,o;if(!!i==(null==this.nested)){if(i){r={},o=this.view.models;for(n in o)s=o[n],r[n]=s;return h={binders:this.view.options.binders,formatters:this.view.options.formatters,config:this.view.options.config},(this.nested=new t.View(e,r,h)).bind(),this.marker.parentNode.insertBefore(e,this.marker.nextSibling)}return e.parentNode.removeChild(e),this.nested.unbind(),delete this.nested}},update:function(t){return this.nested.update(t)}},unless:{block:!0,bind:function(e){return t.binders["if"].bind.call(this,e)},unbind:function(){return t.binders["if"].unbind.call(this)},routine:function(e,i){return t.binders["if"].routine.call(this,e,!i)},update:function(e){return t.binders["if"].update.call(this,e)}},"on-*":{"function":!0,unbind:function(e){return this.handler?t.Util.unbindEvent(e,this.args[0],this.handler):void 0},routine:function(e,i){return this.handler&&t.Util.unbindEvent(e,this.args[0],this.handler),t.Util.bindEvent(e,this.args[0],this.handler=this.eventHandler(i))}},"each-*":{block:!0,bind:function(t){var e;return null==this.marker?(e=["data",this.view.config.prefix,this.type].join("-").replace("--","-"),this.marker=document.createComment(" rivets: "+this.type+" "),this.iterated=[],t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)):void 0},unbind:function(){var t,e,i,n,s;if(null!=this.iterated){for(n=this.iterated,s=[],e=0,i=n.length;i>e;e++)t=n[e],s.push(t.unbind());return s}},routine:function(e,i){var n,s,r,h,o,u,l,a,d,c,p,f,b,v,g,y,m,w,x,k,E;if(l=this.args[0],i=i||[],this.iterated.length>i.length)for(m=Array(this.iterated.length-i.length),b=0,g=m.length;g>b;b++)s=m[b],f=this.iterated.pop(),f.unbind(),this.marker.parentNode.removeChild(f.els[0]);for(E=[],r=v=0,y=i.length;y>v;r=++v)if(u=i[r],n={},n[l]=u,null==this.iterated[r]){w=this.view.models;for(o in w)u=w[o],null==(x=n[o])&&(n[o]=u);d=this.iterated.length?this.iterated[this.iterated.length-1].els[0]:this.marker,a={binders:this.view.options.binders,formatters:this.view.options.formatters,config:{}},k=this.view.options.config;for(h in k)p=k[h],a.config[h]=p;a.config.preloadData=!0,c=e.cloneNode(!0),f=new t.View(c,n,a),f.bind(),this.iterated.push(f),E.push(this.marker.parentNode.insertBefore(c,d.nextSibling))}else this.iterated[r].models[l]!==u?E.push(this.iterated[r].update(n)):E.push(void 0);return E},update:function(t){var e,i,n,s,r,h,o,u;e={};for(i in t)n=t[i],i!==this.args[0]&&(e[i]=n);for(o=this.iterated,u=[],r=0,h=o.length;h>r;r++)s=o[r],u.push(s.update(e));return u}},"class-*":function(t,e){var i;return i=" "+t.className+" ",!e==(-1!==i.indexOf(" "+this.args[0]+" "))?t.className=e?""+t.className+" "+this.args[0]:i.replace(" "+this.args[0]+" "," ").trim():void 0},"*":function(t,e){return e?t.setAttribute(this.type,e):t.removeAttribute(this.type)}},t.internalBinders={textNode:function(t,e){return t.data=null!=e?e:""}},t.config={preloadData:!0,handler:function(t,e,i){return this.call(t,e,i.view.models)}},t.formatters={},t.factory=function(e){return e._=t,e.binders=t.binders,e.formatters=t.formatters,e.config=t.config,e.configure=function(e){var i,n;null==e&&(e={});for(i in e)n=e[i],t.config[i]=n},e.bind=function(e,i,n){var s;return null==i&&(i={}),null==n&&(n={}),s=new t.View(e,i,n),s.bind(),s}},"object"==typeof exports?t.factory(exports):"function"==typeof define&&define.amd?define(["exports"],function(e){return t.factory(this.rivets=e),e}):t.factory(this.rivets={})}).call(this);